# 圧縮アルゴリズム

> データ圧縮の本質は「冗長性の除去」であり、情報理論のシャノン限界が圧縮可能な理論的下限を定める。

## この章で学ぶこと

- [ ] 可逆圧縮と非可逆圧縮の違いを説明できる
- [ ] ハフマン符号とLZ系アルゴリズムの仕組みを理解する
- [ ] 実務で適切な圧縮形式を選択できる

## 前提知識

- 2進数の基礎 → 参照: [[00-binary-and-number-systems.md]]
- 文字コード → 参照: [[01-character-encoding.md]]

---

## 1. 情報理論の基礎

### 1.1 シャノンのエントロピー

```
情報エントロピー: データに含まれる「情報量」の指標

  H = -Σ p(x) × log₂(p(x))

  例: コイン投げ（公平なコイン）
    H = -(0.5 × log₂(0.5) + 0.5 × log₂(0.5))
    H = -(0.5 × (-1) + 0.5 × (-1))
    H = 1 ビット/シンボル ← 理論的最小符号長

  例: 偏ったコイン（表90%, 裏10%）
    H = -(0.9 × log₂(0.9) + 0.1 × log₂(0.1))
    H ≈ -(0.9 × (-0.152) + 0.1 × (-3.322))
    H ≈ 0.469 ビット/シンボル ← 1ビット未満で表現可能！

  → エントロピーが低い = 冗長性が高い = よく圧縮できる
  → エントロピーが高い = ランダムに近い = 圧縮しにくい

  シャノン限界:
    どんなに優れたアルゴリズムでも、エントロピー以下には圧縮できない
```

### 1.2 可逆圧縮 vs 非可逆圧縮

```
┌──────────────────────────────────────────────────┐
│              データ圧縮                           │
├───────────────────┬──────────────────────────────┤
│  可逆圧縮          │  非可逆圧縮                   │
│  (Lossless)       │  (Lossy)                     │
│                   │                              │
│  元データを完全復元 │  元データを近似的に復元         │
│                   │                              │
│  用途:            │  用途:                        │
│  - テキスト       │  - 画像 (JPEG)               │
│  - プログラム     │  - 音声 (MP3, AAC)           │
│  - アーカイブ     │  - 動画 (H.264, VP9, AV1)   │
│                   │                              │
│  形式:            │  圧縮率:                      │
│  - ZIP, gzip      │  - 画像: 10-50倍             │
│  - PNG            │  - 音声: 10-15倍             │
│  - FLAC           │  - 動画: 100-1000倍          │
│                   │                              │
│  圧縮率: 2-5倍程度 │  品質 vs サイズのトレードオフ  │
└───────────────────┴──────────────────────────────┘
```

---

## 2. 可逆圧縮アルゴリズム

### 2.1 ランレングス符号化（RLE）

```
RLE: 同じ値の連続を「値×回数」で表現

  入力:  AAAAAABBCCCCDDDDDDDD
  出力:  A6B2C4D8

  圧縮率: 20文字 → 8文字 (60%削減)

  利点: 実装が極めて単純
  欠点: 同じ値の連続がないと逆効果
        ABCDE → A1B1C1D1E1 (膨張！)

  用途:
  - FAX (白黒の長い連続)
  - BMP画像 (RLE圧縮モード)
  - PCX画像形式
  - 初歩的なゲームグラフィック圧縮
```

### 2.2 ハフマン符号

```
ハフマン符号: 出現頻度の高い文字に短い符号を割り当てる

  例: "ABRACADABRA" (11文字)

  ステップ1: 出現頻度を数える
    A: 5回, B: 2回, R: 2回, C: 1回, D: 1回

  ステップ2: ハフマン木を構築（頻度が低いものから結合）

         [11]
        /    \
      [5]A   [6]
            /    \
          [2]B   [4]
                /    \
              [2]R   [2]
                    /    \
                  [1]C   [1]D

  ステップ3: 符号を割り当て（左=0, 右=1）
    A: 0       (1ビット)
    B: 10      (2ビット)
    R: 110     (3ビット)
    C: 1110    (4ビット)
    D: 1111    (4ビット)

  ステップ4: 符号化
    ABRACADABRA
    = 0 10 110 0 1110 0 1111 0 10 110 0
    = 0101100111001111010110 0
    = 23ビット = 約3バイト

  元のデータ: 11文字 × 8ビット = 88ビット
  圧縮後: 23ビット + ヘッダ（木の情報）
  → 約74%削減（ヘッダを除く）

  特性:
  - 前置符号（prefix-free code）: どの符号も他の符号の先頭部分にならない
  - 最適前置符号: 出現頻度が既知の場合に最適
  - gzip, JPEG, MP3 の内部で使用
```

### 2.3 LZ77 / LZ78 / LZW

```
LZ77（Lempel-Ziv 1977）: スライディングウィンドウ方式

  原理: 過去に出現した文字列パターンを「戻り距離 + 長さ」で参照

  入力: "ABCABCABC"

  処理:
  位置0: A → リテラル 'A'
  位置1: B → リテラル 'B'
  位置2: C → リテラル 'C'
  位置3: ABC → (距離3, 長さ3) — 3文字前の"ABC"と同じ
  位置6: ABC → (距離3, 長さ3) — 3文字前の"ABC"と同じ

  出力: A B C (3,3) (3,3)

  用途: gzip, deflate, zstd の基盤

LZ78 / LZW: 辞書方式

  原理: 出現するパターンを辞書に登録し、辞書番号で参照

  LZW は GIF, TIFF, Unix compress で使用
  → GIF の特許問題（Unisys）→ PNG の誕生のきっかけ

DEFLATE: LZ77 + ハフマン符号 の組み合わせ
  1. LZ77 で繰り返しパターンを圧縮
  2. ハフマン符号で各シンボルを最適符号化
  → ZIP, gzip, PNG, HTTP圧縮 の中核アルゴリズム
```

### 2.4 現代の圧縮アルゴリズム

```
圧縮アルゴリズムの進化:

  アルゴリズム    年   圧縮率   速度    用途
  ──────────────────────────────────────────────
  gzip (DEFLATE)  1992  標準    中     HTTP, ファイル圧縮
  bzip2           1996  高     遅い   アーカイブ
  LZ4             2011  低     超高速  リアルタイム、DB
  Snappy          2011  低     超高速  BigTable, Kafka
  Zstandard(zstd) 2016  高     高速   汎用、Meta開発
  Brotli          2015  最高   中     HTTP圧縮 (Google)

  ベンチマーク（Silesia Corpus, 圧縮率×速度）:
  ┌────────┬──────────┬──────────┬──────────┐
  │ 名前    │ 圧縮率   │ 圧縮速度  │ 展開速度  │
  │        │ (小=良)  │ (MB/s)   │ (MB/s)   │
  ├────────┼──────────┼──────────┼──────────┤
  │ LZ4    │ 2.10     │ 780      │ 4,560    │
  │ Snappy │ 2.09     │ 565      │ 1,800    │
  │ zstd   │ 2.88     │ 510      │ 1,380    │
  │ gzip   │ 3.17     │ 36       │ 410      │
  │ bzip2  │ 3.45     │ 14       │ 56       │
  │ Brotli │ 3.58     │ 5        │ 430      │
  └────────┴──────────┴──────────┴──────────┘

  選択指針:
  - リアルタイム/DB: LZ4 or Snappy（速度優先）
  - 汎用圧縮: zstd（圧縮率と速度のバランス最良）
  - Web配信: Brotli（圧縮率最高、CDNで事前圧縮）
  - レガシー互換: gzip
```

---

## 3. 非可逆圧縮

### 3.1 画像圧縮

```
JPEG圧縮の仕組み:

  1. 色空間変換: RGB → YCbCr（輝度 + 色差）
     → 人間の目は輝度に敏感、色差には鈍感
     → 色差成分を間引く（4:2:0 = 色解像度を半分）

  2. DCT（離散コサイン変換）: 8×8ブロックごとに周波数変換
     → 空間情報 → 周波数情報
     → 低周波（大きな色の変化）+ 高周波（細かい模様）

  3. 量子化: 高周波成分を荒く丸める（ここで情報が失われる）
     → 品質設定（1-100）= 量子化の荒さ
     → 品質75で十分実用的、50以下は目に見える劣化

  4. エントロピー符号化: ハフマン符号 or 算術符号化
     → 可逆圧縮で最終的にサイズ削減

  JPEG品質 vs ファイルサイズ（1920×1080 写真の例）:
    品質100: 約2MB  (圧縮率 3:1)
    品質 85: 約500KB (圧縮率 12:1)
    品質 75: 約300KB (圧縮率 20:1)
    品質 50: 約150KB (圧縮率 40:1)
    品質 10: 約 50KB (圧縮率 120:1) ← ブロックノイズ顕著

画像形式の比較:
  ┌───────┬──────┬──────────┬─────────────────────────┐
  │ 形式   │ 圧縮  │ 透過     │ 用途                    │
  ├───────┼──────┼──────────┼─────────────────────────┤
  │ JPEG  │ 非可逆│ ×       │ 写真                    │
  │ PNG   │ 可逆  │ ○(α)   │ UI、スクリーンショット   │
  │ GIF   │ 可逆  │ ○(1bit)│ アニメーション(256色)    │
  │ WebP  │ 両方  │ ○(α)   │ Web(Google推奨)         │
  │ AVIF  │ 非可逆│ ○(α)   │ 次世代Web画像           │
  │ SVG   │ -    │ ○       │ ベクター画像            │
  └───────┴──────┴──────────┴─────────────────────────┘
```

### 3.2 音声圧縮

```
音声圧縮:

  非圧縮 WAV: 44.1kHz × 16bit × 2ch = 1,411 kbps

  MP3 (MPEG Audio Layer 3, 1993):
    - 心理音響モデル: 人間が知覚できない音を除去
    - マスキング効果: 大きな音の近くの小さな音は聞こえない
    - 128kbps: CD品質の約1/11 → ほとんどの人には十分
    - 320kbps: ほぼ区別不能

  AAC (Advanced Audio Coding):
    - MP3の後継。同ビットレートでMP3より高音質
    - Apple Music, YouTube で標準

  Opus (2012):
    - 低レイテンシ(2.5ms〜) + 高圧縮
    - VoIP (Discord, WebRTC) から音楽まで万能
    - オープンソース、ロイヤリティフリー

  FLAC (可逆):
    - 元音質を完全に復元
    - 圧縮率: 約50-70%
    - オーディオマニア、マスター保存用
```

### 3.3 動画圧縮

```
動画圧縮の基本:

  非圧縮 1080p 30fps:
    1920 × 1080 × 3bytes × 30fps = 約186 MB/秒 = 約1.5 Gbps

  H.264 (AVC, 2003):
    - Iフレーム: 単独で完結する基準画像（JPEGに近い）
    - Pフレーム: 前のフレームとの「差分」のみ保存
    - Bフレーム: 前後のフレームから予測
    - 動き補償: 「この領域は左に10px移動した」のように記録
    - 1080p: 約5-8 Mbps → 圧縮率 約200:1

  H.265 (HEVC, 2013):
    - H.264の約半分のビットレートで同等品質
    - 4K/8K向け。エンコード負荷大
    - ライセンス問題（高額ロイヤリティ）

  AV1 (2018):
    - Google/Netflix/Amazon等が開発（AOMedia）
    - H.265と同等以上の圧縮率
    - ロイヤリティフリー → YouTube, Netflix で採用
    - エンコード速度は遅い（改善中）
```

---

## 4. 実務での圧縮

### 4.1 HTTP圧縮

```
Webでの圧縮:

  ブラウザ                          サーバー
  │                               │
  │──Accept-Encoding: gzip, br──→ │  リクエスト
  │                               │
  │←─Content-Encoding: br────────│  レスポンス
  │   (Brotli圧縮されたデータ)     │
  │                               │

  HTTP圧縮の効果（HTMLの場合）:
  元サイズ: 100KB
  gzip:     25KB (75%削減)
  Brotli:   20KB (80%削減)

  設定例（Nginx）:
  gzip on;
  gzip_types text/html text/css application/javascript application/json;
  gzip_min_length 256;

  Content-Typeごとの圧縮効果:
  テキスト (HTML/CSS/JS/JSON): 70-85%削減 ← 非常に効果的
  画像 (JPEG/PNG): ほぼ0% ← 既に圧縮済み
  フォント (woff2): ほぼ0% ← 既にBrotli圧縮済み
```

### 4.2 データベースの圧縮

```python
# PostgreSQL: TOAST（自動圧縮）
# 2KB以上のカラムデータを自動的にLZ圧縮

# MySQL InnoDB: ページ圧縮
# CREATE TABLE t1 (...) ROW_FORMAT=COMPRESSED KEY_BLOCK_SIZE=8;

# Redis: メモリ圧縮
# ziplist, intset, listpack で小さなデータ構造を圧縮表現

# ColumnDB: 列指向圧縮
# 同じ型のデータが連続 → RLE, Dictionary Encoding が効果的
# 例: 性別カラム ["M","F","M","M","F",...] → 辞書: {0:"M", 1:"F"} + [0,1,0,0,1,...]
```

---

## 5. 実践演習

### 演習1: ハフマン符号（基礎）
文字列 "MISSISSIPPI" に対してハフマン符号を構築し、圧縮後のビット数を計算せよ。

### 演習2: 圧縮率の比較（応用）
同じ100MBのテキストファイルを gzip, zstd, brotli, lz4 で圧縮し、圧縮率と圧縮/展開速度を比較せよ。

### 演習3: 簡易LZ77の実装（発展）
スライディングウィンドウ方式のLZ77エンコーダ/デコーダを好きな言語で実装せよ。

---

## FAQ

### Q1: 既に圧縮されたデータをさらに圧縮できますか？
**A**: ほぼ不可能。圧縮されたデータはエントロピーが高く（ランダムに近い）、冗長性がほとんどない。JPEGをZIPしてもサイズはほぼ変わらない。ただし異なるアルゴリズムの組み合わせ（LZ77 + ハフマン = DEFLATE）は効果的。

### Q2: ZIPとgzipとtar.gzの違いは？
**A**: ZIP = アーカイブ（複数ファイル統合）+ 圧縮。gzip = 単一ファイル圧縮。tar = アーカイブのみ（圧縮なし）。tar.gz = tarでまとめてからgzipで圧縮。Unix文化ではtar.gzが標準、Windows文化ではZIPが標準。

### Q3: なぜ動画ファイルは圧縮しても小さくならないのですか？
**A**: H.264/H.265/AV1で既に非可逆圧縮済みのため。元の非圧縮動画から数百倍に圧縮されている状態。ZIPやgzipはこれ以上の冗長性を見つけられない。

---

## まとめ

| 概念 | ポイント |
|------|---------|
| エントロピー | データの情報量。圧縮の理論的下限を決める |
| 可逆圧縮 | 完全復元可能。テキスト/プログラム向け。2-5倍 |
| 非可逆圧縮 | 近似復元。画像/音声/動画向け。10-1000倍 |
| 実務選択 | 速度重視:LZ4、バランス:zstd、Web:Brotli |
| HTTP圧縮 | テキストに70-85%の効果。画像は効果なし |

---

## 次に読むべきガイド
→ [[05-storage-capacity.md]] — データ量の感覚

---

## 参考文献
1. Shannon, C. E. "A Mathematical Theory of Communication." Bell System Technical Journal, 1948.
2. Huffman, D. A. "A Method for the Construction of Minimum-Redundancy Codes." 1952.
3. Ziv, J. & Lempel, A. "A Universal Algorithm for Sequential Data Compression." IEEE IT, 1977.
4. Collet, Y. "Zstandard Compression." RFC 8478, 2018.
5. Alakuijala, J. & Szabadka, Z. "Brotli Compressed Data Format." RFC 7932, 2016.
