# Tox Configuration Template
# tox.ini - 複数環境でのテスト自動化

[tox]
# テスト対象の Python バージョン
envlist = py311,py312,lint,type,docs
isolated_build = True
skip_missing_interpreters = True

# デフォルトのテスト環境
[testenv]
description = Run unit tests
deps =
    pytest>=7.4.0
    pytest-cov>=4.1.0
    pytest-asyncio>=0.21.0
    pytest-mock>=3.12.0
commands =
    pytest {posargs:tests}

# Python 3.11
[testenv:py311]
basepython = python3.11

# Python 3.12
[testenv:py312]
basepython = python3.12

# Linting (Ruff)
[testenv:lint]
description = Run linters
skip_install = True
deps =
    ruff>=0.1.6
commands =
    ruff check src tests
    ruff format --check src tests

# Type checking (mypy)
[testenv:type]
description = Run type checker
deps =
    mypy>=1.7.0
    pydantic>=2.5.0
    types-requests
commands =
    mypy src

# Code formatting (Black)
[testenv:format]
description = Format code
skip_install = True
deps =
    black>=23.11.0
    ruff>=0.1.6
commands =
    black src tests
    ruff format src tests

# Security check (Bandit)
[testenv:security]
description = Run security checks
skip_install = True
deps =
    bandit[toml]>=1.7.5
commands =
    bandit -r src -c pyproject.toml

# Documentation (Sphinx)
[testenv:docs]
description = Build documentation
deps =
    sphinx>=7.2.0
    sphinx-rtd-theme>=2.0.0
    myst-parser>=2.0.0
commands =
    sphinx-build -W -b html docs docs/_build/html

# Coverage report
[testenv:coverage]
description = Generate coverage report
deps =
    {[testenv]deps}
    coverage[toml]>=7.3.0
commands =
    coverage run -m pytest tests
    coverage report
    coverage html
    coverage xml

# Development environment
[testenv:dev]
description = Development environment
usedevelop = True
deps =
    {[testenv]deps}
    {[testenv:lint]deps}
    {[testenv:type]deps}
    ipython>=8.17.0
    ipdb>=0.13.13
commands =

# Build package
[testenv:build]
description = Build package
skip_install = True
deps =
    build>=1.0.0
    twine>=4.0.0
commands =
    python -m build
    twine check dist/*

# Clean environment
[testenv:clean]
description = Clean generated files
skip_install = True
whitelist_externals = rm
commands =
    rm -rf build dist *.egg-info
    rm -rf .pytest_cache .mypy_cache .ruff_cache
    rm -rf htmlcov coverage.xml .coverage

# pytest 設定
[pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts =
    -ra
    --strict-markers
    --cov=src
    --cov-report=term-missing
    --cov-report=html
    --cov-report=xml

# coverage 設定
[coverage:run]
source = src
branch = True
omit =
    */tests/*
    */__pycache__/*

[coverage:report]
precision = 2
show_missing = True
skip_covered = False
