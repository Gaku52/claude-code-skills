# DNS（Domain Name System）

> DNSはインターネットの「電話帳」。人間が覚えやすいドメイン名を、コンピュータが理解できるIPアドレスに変換する。再帰/反復クエリ、DNSレコード、キャッシュの仕組みを理解する。

## この章で学ぶこと

- [ ] DNSの名前解決プロセスを理解する
- [ ] 再帰クエリと反復クエリの違いを把握する
- [ ] 主要なDNSレコードの種類と用途を学ぶ

---

## 1. DNSの基本

```
なぜDNSが必要か:
  人間:     example.com（覚えやすい）
  コンピュータ: 93.184.216.34（IPアドレス）

  → DNSが両者を橋渡し

DNSの階層構造:
  .（ルート）
  ├── com.
  │   ├── example.com.
  │   ├── google.com.
  │   └── github.com.
  ├── org.
  │   ├── wikipedia.org.
  │   └── mozilla.org.
  ├── jp.
  │   ├── co.jp.
  │   │   └── example.co.jp.
  │   └── ac.jp.
  └── net.

FQDN（完全修飾ドメイン名）:
  www.example.com.
  ↑   ↑       ↑  ↑
  ホスト ドメイン TLD ルート（通常省略）
```

---

## 2. 名前解決の流れ

```
ブラウザで https://www.example.com を開く:

  1. ブラウザキャッシュを確認
     → キャッシュにあればそれを使用

  2. OSのDNSキャッシュを確認
     → /etc/hosts も参照

  3. リゾルバ（ISPのDNSサーバー）に問い合わせ
     → キャッシュにあればそれを返す

  4. リゾルバがルートDNSサーバーに問い合わせ
     「.com のネームサーバーは？」
     → a.gtld-servers.net（192.5.6.30）

  5. リゾルバが .com のDNSサーバーに問い合わせ
     「example.com のネームサーバーは？」
     → ns1.example.com（198.51.100.1）

  6. リゾルバが example.com の権威DNSサーバーに問い合わせ
     「www.example.com のIPアドレスは？」
     → 93.184.216.34

  7. リゾルバがクライアントに結果を返す
     → TTLの間キャッシュ

図解:
  クライアント
    ↓ ①
  リゾルバ（再帰DNS）
    ↓ ② ルートDNS（13クラスタ: a〜m.root-servers.net）
    ↓ ③ TLD DNS（.com, .org, .jp ...）
    ↓ ④ 権威DNS（example.com のゾーンを管理）
    ↓ ⑤ 結果を返す
  クライアント
```

---

## 3. 再帰クエリと反復クエリ

```
再帰クエリ（Recursive Query）:
  クライアント → リゾルバ
  「最終的な答えをください」
  → リゾルバが全ての問い合わせを代行
  → クライアントは結果を待つだけ

反復クエリ（Iterative Query）:
  リゾルバ → 各DNSサーバー
  「知っている範囲で教えて」
  → 「自分は知らないが、○○に聞いてみて」と参照を返す
  → リゾルバが次のサーバーに自分で問い合わせ

  クライアント ──再帰──→ リゾルバ
                          ├──反復──→ ルートDNS
                          │          「.comはここ」
                          ├──反復──→ .com DNS
                          │          「example.comはここ」
                          └──反復──→ 権威DNS
                                     「93.184.216.34」
```

---

## 4. DNSレコードの種類

```
主要なDNSレコード:

┌────────┬───────────────────────────────────────────────┐
│ タイプ │ 説明                                          │
├────────┼───────────────────────────────────────────────┤
│ A      │ ドメイン → IPv4アドレス                       │
│        │ example.com → 93.184.216.34                   │
├────────┼───────────────────────────────────────────────┤
│ AAAA   │ ドメイン → IPv6アドレス                       │
│        │ example.com → 2606:2800:220:1:248:1893:25c8:1946│
├────────┼───────────────────────────────────────────────┤
│ CNAME  │ ドメインの別名（エイリアス）                  │
│        │ www.example.com → example.com                 │
├────────┼───────────────────────────────────────────────┤
│ MX     │ メールサーバーの指定                          │
│        │ example.com → mail.example.com（優先度: 10）  │
├────────┼───────────────────────────────────────────────┤
│ TXT    │ テキスト情報（SPF, DKIM, ドメイン検証等）     │
│        │ "v=spf1 include:_spf.google.com ~all"         │
├────────┼───────────────────────────────────────────────┤
│ NS     │ ゾーンの権威ネームサーバー                    │
│        │ example.com → ns1.example.com                 │
├────────┼───────────────────────────────────────────────┤
│ SOA    │ ゾーンの管理情報（シリアル番号、TTL等）       │
├────────┼───────────────────────────────────────────────┤
│ SRV    │ サービスの場所（ポート番号付き）               │
│        │ _sip._tcp.example.com → 5060 sipserver.example.com│
├────────┼───────────────────────────────────────────────┤
│ PTR    │ IPアドレス → ドメイン（逆引き）               │
│        │ 34.216.184.93.in-addr.arpa → example.com      │
├────────┼───────────────────────────────────────────────┤
│ CAA    │ 証明書発行の許可先CA                          │
│        │ example.com → letsencrypt.org                 │
└────────┴───────────────────────────────────────────────┘

実務でよく使う dig コマンド:
  $ dig example.com A          # Aレコードを問い合わせ
  $ dig example.com MX         # MXレコード
  $ dig +short example.com     # IPアドレスのみ表示
  $ dig @8.8.8.8 example.com   # Google DNSに直接問い合わせ
  $ dig +trace example.com     # 解決過程を表示

nslookup:
  $ nslookup example.com
  $ nslookup -type=MX example.com
```

---

## 5. DNSキャッシュとTTL

```
TTL（Time To Live）:
  → DNSレコードをキャッシュする秒数
  → TTL経過後、再度DNSに問い合わせ

  TTLの設定例:
  短い（60秒）:
    ✓ DNS切り替えが速い
    ✗ DNSサーバーへの負荷が高い
    → フェイルオーバー、Blue-Greenデプロイ時

  長い（86400秒 = 24時間）:
    ✓ DNSサーバーへの負荷が低い
    ✓ 名前解決が速い
    ✗ 変更の反映に最大24時間
    → 安定したサービス

  移行時のベストプラクティス:
    1. TTLを300秒（5分）に短縮して待機（24時間以上）
    2. DNSレコードを変更
    3. 伝搬を確認（5分〜数時間）
    4. 安定後、TTLを元に戻す

キャッシュの階層:
  ブラウザキャッシュ（Chrome: chrome://net-internals/#dns）
    ↓ ミス
  OSキャッシュ（macOS: dscacheutil -flushcache）
    ↓ ミス
  ルーターキャッシュ
    ↓ ミス
  ISPリゾルバキャッシュ
    ↓ ミス
  権威DNSサーバーに問い合わせ
```

---

## 6. AWSでのDNS（Route 53）

```
Route 53 = AWSのマネージドDNSサービス

主な機能:
  1. ドメイン登録
  2. DNSホスティング（権威DNS）
  3. ヘルスチェック + ルーティング

ルーティングポリシー:
  ┌───────────────┬──────────────────────────────────┐
  │ ポリシー       │ 説明                             │
  ├───────────────┼──────────────────────────────────┤
  │ シンプル       │ 1つのリソースにルーティング       │
  │ 加重          │ 割合ベースで振り分け（A/Bテスト） │
  │ レイテンシー   │ 最も遅延の少ないリージョンへ     │
  │ フェイルオーバー│ プライマリ障害時にセカンダリへ   │
  │ 位置情報       │ ユーザーの地理的位置に基づく     │
  │ 複数値応答     │ 最大8つのIPをランダムに返す      │
  └───────────────┴──────────────────────────────────┘

エイリアスレコード（AWS固有）:
  → CNAMEと似ているが、ゾーンの頂点（example.com）にも使える
  → CloudFront, ELB, S3 等のAWSリソースを直接指定
  → DNSクエリ料金が無料
```

---

## まとめ

| 概念 | ポイント |
|------|---------|
| DNS | ドメイン名 → IPアドレスの変換 |
| 再帰クエリ | クライアント→リゾルバ（最終結果を返す） |
| 反復クエリ | リゾルバ→各DNS（参照を返す） |
| TTL | キャッシュの有効期間（秒） |
| レコード | A, AAAA, CNAME, MX, TXT, NS 等 |

---

## 次に読むべきガイド
→ [[01-protocols/00-tcp.md]] — TCP

---

## 参考文献
1. RFC 1035. "Domain Names - Implementation and Specification." IETF, 1987.
2. RFC 8499. "DNS Terminology." IETF, 2019.
