# CDN（Content Delivery Network）

> CDNは世界中のエッジサーバーにコンテンツをキャッシュし、ユーザーに最も近い場所から配信する。レイテンシ削減、帯域節約、DDoS防御の仕組みと、主要CDNサービスの比較を学ぶ。

## この章で学ぶこと

- [ ] CDNの仕組みとアーキテクチャを理解する
- [ ] キャッシュ戦略とパージの方法を把握する
- [ ] 主要CDNサービスの特徴と選び方を学ぶ

---

## 1. CDNの基本

```
CDNの仕組み:

  CDNなし:
  東京ユーザー ──→ USオリジンサーバー（100ms）
  大阪ユーザー ──→ USオリジンサーバー（100ms）
  EUユーザー   ──→ USオリジンサーバー（200ms）

  CDNあり:
  東京ユーザー ──→ 東京エッジ（5ms）──→ USオリジン（キャッシュミス時のみ）
  大阪ユーザー ──→ 大阪エッジ（3ms）
  EUユーザー   ──→ EUエッジ（10ms）

CDNアーキテクチャ:
  ┌──────────┐     ┌──────────┐
  │ オリジン  │     │ オリジン  │
  │ サーバー  │     │ (S3等)   │
  └─────┬────┘     └─────┬────┘
        │                 │
  ┌─────▼─────────────────▼─────┐
  │      CDNバックボーン          │
  │  ┌─────┐  ┌─────┐  ┌─────┐ │
  │  │東京 │  │US   │  │EU   │ │
  │  │エッジ│  │エッジ│  │エッジ│ │
  │  └──┬──┘  └──┬──┘  └──┬──┘ │
  └─────┼────────┼────────┼─────┘
        │        │        │
     東京      US       EU
     ユーザー  ユーザー  ユーザー

CDNが配信するもの:
  ① 静的ファイル: HTML, CSS, JS, 画像, フォント
  ② 動画/音声: HLS/DASHストリーミング
  ③ APIレスポンス: キャッシュ可能なAPI
  ④ 動的コンテンツ: Edge Computing（Cloudflare Workers等）
```

---

## 2. CDNキャッシュ戦略

```
キャッシュの判断:

  キャッシュすべきもの:
  ✓ 静的ファイル（CSS, JS, 画像）— 長時間キャッシュ
  ✓ パブリックAPIレスポンス — 短時間キャッシュ
  ✓ 変更頻度の低いページ

  キャッシュすべきでないもの:
  ✗ ユーザー固有のデータ（マイページ等）
  ✗ リアルタイムデータ（在庫数、株価）
  ✗ 認証が必要なAPIレスポンス

キャッシュキー:
  URL + クエリパラメータ + ヘッダー（設定による）

  同じURL → 同じキャッシュ:
  https://cdn.example.com/style.css

  クエリで区別:
  https://cdn.example.com/api/data?lang=ja
  https://cdn.example.com/api/data?lang=en

  ヘッダーで区別（Accept-Encoding等）:
  → gzip/br で異なるキャッシュ

キャッシュヒット率の目標:
  静的サイト: 95%以上
  動的サイト: 70-90%
  API: 40-70%
  → ヒット率が高いほどオリジン負荷が減少
```

---

## 3. キャッシュパージ（無効化）

```
パージの方法:

  ① パスベースパージ:
     → /images/logo.png を個別にパージ
     → 最も精密

  ② ワイルドカードパージ:
     → /images/* を一括パージ
     → CDNによってサポート状況が異なる

  ③ 全パージ:
     → キャッシュ全体をクリア
     → 最も簡単だがオリジンへの負荷急増に注意

  ④ タグベースパージ:
     → Surrogate-Key ヘッダーでタグ付け
     → タグ指定でパージ（Fastly等）

  ⑤ バージョニング（パージ不要）:
     → app.a1b2c3.js のようにファイル名にハッシュ
     → 新しいファイル名 = 新しいキャッシュ
     → 推奨: パージ自体を不要にする設計

CloudFront のInvalidation:
  aws cloudfront create-invalidation \
    --distribution-id E1234567890 \
    --paths "/index.html" "/api/*"

  注意:
  → 月1,000パスまで無料、以降$0.005/パス
  → 伝搬に数分〜数十分かかる
```

---

## 4. Edge Computing

```
Edge Computing = CDNエッジでコードを実行

  従来: ブラウザ → CDN(キャッシュ) → オリジンサーバー
  Edge: ブラウザ → CDN(コード実行) → 必要時のみオリジン

  用途:
  ① A/Bテスト: エッジでリクエストを振り分け
  ② パーソナライゼーション: 地域/デバイスに応じた応答
  ③ 認証・認可: エッジでJWT検証
  ④ リダイレクト: エッジで即座に処理
  ⑤ 画像最適化: フォーマット変換/リサイズ

主要なEdge Computing:
  Cloudflare Workers:
    → V8 isolate ベース（Node.jsではない）
    → 0ms コールドスタート
    → 世界300+拠点

  Vercel Edge Functions:
    → Next.js と統合
    → Edge Runtime

  AWS CloudFront Functions:
    → 軽量な処理（ヘッダー操作等）
    → Lambda@Edge より高速・安価

  AWS Lambda@Edge:
    → CloudFront イベントでLambda実行
    → より高度な処理が可能
```

---

## 5. 主要CDNサービス比較

```
┌──────────────┬────────────┬──────────────────────────┐
│ サービス      │ 拠点数     │ 特徴                     │
├──────────────┼────────────┼──────────────────────────┤
│ CloudFront   │ 600+       │ AWS統合、Lambda@Edge     │
│ (AWS)        │            │ S3/ELBとの連携が容易      │
├──────────────┼────────────┼──────────────────────────┤
│ Cloudflare   │ 300+       │ 無料プランあり、Workers   │
│              │            │ DDoS保護が強力            │
├──────────────┼────────────┼──────────────────────────┤
│ Fastly       │ 90+        │ リアルタイムパージ(<1秒)  │
│              │            │ VCL/Wasm対応              │
├──────────────┼────────────┼──────────────────────────┤
│ Vercel       │ (自動)     │ Next.js最適化             │
│              │            │ Edge Functions統合        │
├──────────────┼────────────┼──────────────────────────┤
│ Akamai       │ 4,000+     │ 最大規模、企業向け       │
│              │            │ 高度なセキュリティ機能    │
└──────────────┴────────────┴──────────────────────────┘

選定基準:
  AWSメイン  → CloudFront（統合が容易）
  個人/中小  → Cloudflare（無料〜低コスト）
  高頻度更新 → Fastly（即時パージ）
  Next.js    → Vercel（最適化済み）
  エンタープライズ → Akamai
```

---

## まとめ

| 概念 | ポイント |
|------|---------|
| CDN | エッジキャッシュでレイテンシ削減 |
| キャッシュ戦略 | 静的=長期、動的=短期、認証付き=なし |
| パージ | バージョニングで不要化が理想 |
| Edge Computing | CDNエッジでコード実行 |

---

## 次に読むべきガイド
→ [[02-network-debugging.md]] — ネットワークデバッグ

---

## 参考文献
1. AWS. "Amazon CloudFront Developer Guide." 2024.
2. Cloudflare. "How does a CDN work?" 2024.
