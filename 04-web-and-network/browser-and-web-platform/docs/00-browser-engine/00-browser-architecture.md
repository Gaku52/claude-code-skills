# ブラウザアーキテクチャ

> モダンブラウザはマルチプロセスアーキテクチャで動作する。ブラウザプロセス、レンダラープロセス、GPUプロセス等の役割分担と、タブごとの分離がセキュリティとパフォーマンスにもたらす利点を理解する。

## この章で学ぶこと

- [ ] ブラウザのマルチプロセスアーキテクチャを理解する
- [ ] 各プロセスの役割と連携を把握する
- [ ] ブラウザエンジンの主要コンポーネントを学ぶ

---

## 1. マルチプロセスアーキテクチャ

```
モダンブラウザ（Chrome）のプロセス構成:

  ┌───────────────────────────────────────┐
  │ ブラウザプロセス（Browser Process）    │
  │ → アドレスバー、ブックマーク、戻る/進む │
  │ → ネットワーク要求の管理               │
  │ → ファイルアクセスの制御               │
  └──────────┬──────────┬──────────┬──────┘
             │          │          │
  ┌──────────▼──┐ ┌─────▼──────┐ ┌▼──────────┐
  │ レンダラー   │ │ レンダラー  │ │ レンダラー  │
  │ プロセス     │ │ プロセス    │ │ プロセス    │
  │ (タブ1)     │ │ (タブ2)    │ │ (タブ3)    │
  └─────────────┘ └────────────┘ └────────────┘
        │              │              │
  ┌─────▼──────────────▼──────────────▼─────┐
  │ GPU プロセス（GPU Process）               │
  │ → 全タブの描画処理を一括管理              │
  └─────────────────────────────────────────┘

  その他のプロセス:
  ┌───────────────┐  ┌───────────────┐
  │ ネットワーク   │  │ ストレージ     │
  │ サービス       │  │ サービス       │
  │ プロセス       │  │ プロセス       │
  └───────────────┘  └───────────────┘

なぜマルチプロセスか:
  ① 安定性: 1つのタブがクラッシュしても他のタブに影響しない
  ② セキュリティ: サンドボックスで各タブを隔離
  ③ パフォーマンス: マルチコアCPUを活用

代償:
  → メモリ消費が多い（プロセスごとにメモリ空間）
  → Chrome のタブ1つ ≈ 50-300MB
  → メモリ圧迫時はプロセスを統合（process-per-site）
```

---

## 2. レンダラープロセスの内部

```
レンダラープロセスの主要コンポーネント:

  ┌──────────────────────────────────────────┐
  │ レンダラープロセス                        │
  │                                          │
  │ ┌──────────────────────────────────────┐ │
  │ │ メインスレッド                        │ │
  │ │ ├── HTML パーサー                    │ │
  │ │ ├── CSS パーサー                     │ │
  │ │ ├── JavaScript エンジン（V8）         │ │
  │ │ ├── レイアウトエンジン                │ │
  │ │ └── ペイント                         │ │
  │ └──────────────────────────────────────┘ │
  │                                          │
  │ ┌──────────────────────────────────────┐ │
  │ │ コンポジタースレッド                  │ │
  │ │ → レイヤーの合成（GPU活用）           │ │
  │ └──────────────────────────────────────┘ │
  │                                          │
  │ ┌──────────────────────────────────────┐ │
  │ │ ラスタースレッド（複数）              │ │
  │ │ → ピクセルの描画（タイルベース）      │ │
  │ └──────────────────────────────────────┘ │
  │                                          │
  │ ┌──────────────────────────────────────┐ │
  │ │ Web Worker スレッド                   │ │
  │ │ → バックグラウンド処理                │ │
  │ └──────────────────────────────────────┘ │
  └──────────────────────────────────────────┘

重要: メインスレッドは1つだけ
  → HTML パース、CSS 計算、JS 実行、レイアウト、ペイント
  → 全てが1つのスレッドで順番に実行
  → JS が長時間実行 → レンダリングがブロック → UI フリーズ
```

---

## 3. ブラウザエンジンの比較

```
主要なブラウザエンジン:

  ┌───────────┬──────────────┬──────────┬──────────────┐
  │ ブラウザ   │ レンダリング │ JSエンジン│ 備考         │
  ├───────────┼──────────────┼──────────┼──────────────┤
  │ Chrome    │ Blink        │ V8       │ 最大シェア   │
  │ Edge      │ Blink        │ V8       │ Chromiumベース│
  │ Safari    │ WebKit       │ JSCore   │ Apple独自    │
  │ Firefox   │ Gecko        │ SpiderMonkey│ Mozilla    │
  │ Opera     │ Blink        │ V8       │ Chromiumベース│
  │ Brave     │ Blink        │ V8       │ Chromiumベース│
  └───────────┴──────────────┴──────────┴──────────────┘

  現状: Blink (Chromium) が圧倒的シェア
  → Chrome + Edge + Opera + Brave + Samsung Internet
  → 全ブラウザの約80%

  WebKit (Safari):
  → iOS では全ブラウザが WebKit を使用（Appleの規則）
  → ※ EU ではこの制限が緩和されつつある（2024年〜）

  Gecko (Firefox):
  → 唯一の完全独立エンジン
  → Web標準の多様性維持に重要
```

---

## 4. プロセス間通信（IPC）

```
プロセス間の連携:

  ブラウザプロセス ←→ レンダラープロセス:
  → Mojo IPC（Chrome内部のIPC機構）
  → メッセージパッシング

  例: URLナビゲーション
  1. ユーザーがアドレスバーにURL入力
  2. ブラウザプロセス: URLを検証
  3. ブラウザプロセス → ネットワークサービス: リクエスト送信
  4. ネットワークサービス: レスポンス受信
  5. ブラウザプロセス → レンダラープロセス: HTMLを渡す
  6. レンダラープロセス: パース → レンダリング
  7. レンダラープロセス → GPU プロセス: 描画コマンド
  8. GPU プロセス: 画面に描画

  Site Isolation（サイト分離）:
  → 異なるサイトのiframeは別プロセスで実行
  → Spectre/Meltdown 対策
  → クロスサイト攻撃の防止
```

---

## 5. DevTools でプロセスを確認

```
Chrome のタスクマネージャ:
  → Shift + Esc（Windows/Linux）
  → Window > Task Manager（Mac）

  表示される情報:
  ┌─────────────────────┬──────┬───────┐
  │ タスク               │ メモリ│ CPU   │
  ├─────────────────────┼──────┼───────┤
  │ ブラウザ             │ 150MB│ 2%    │
  │ GPU プロセス          │ 200MB│ 5%    │
  │ タブ: example.com    │ 85MB │ 1%    │
  │ タブ: youtube.com    │ 250MB│ 15%   │
  │ 拡張: AdBlock        │ 30MB │ 0%    │
  │ Service Worker       │ 20MB │ 0%    │
  └─────────────────────┴──────┴───────┘

  → メモリを大量消費しているタブの特定
  → CPUを消費しているプロセスの特定

chrome://tracing:
  → 全プロセスのタイムライン詳細分析
  → レンダリングパイプラインの各段階を可視化
```

---

## まとめ

| 概念 | ポイント |
|------|---------|
| マルチプロセス | タブ=レンダラープロセス（安定性+セキュリティ） |
| メインスレッド | HTML/CSS/JS/レイアウトが1スレッド |
| ブラウザエンジン | Blink(Chrome), WebKit(Safari), Gecko(Firefox) |
| Site Isolation | 異なるサイトを別プロセスで隔離 |

---

## 次に読むべきガイド
→ [[01-navigation-and-loading.md]] — ナビゲーションとローディング

---

## 参考文献
1. Mariko Kosaka. "Inside look at modern web browser." Google, 2018.
2. Chromium Blog. "Site Isolation." 2019.
