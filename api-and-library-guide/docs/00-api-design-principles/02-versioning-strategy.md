# バージョニング戦略

> APIのバージョニングは後方互換性と進化のバランス。破壊的変更の定義、URI/ヘッダーベースの戦略、非推奨化プロセスを理解し、長期運用に耐えるAPIを設計する。

## この章で学ぶこと

- [ ] 破壊的変更と非破壊的変更を区別する
- [ ] バージョニング方式の比較と選択基準を把握する
- [ ] 非推奨化と移行のプロセスを学ぶ

---

## 1. 破壊的変更の定義

```
非破壊的変更（バージョンアップ不要）:
  ✓ レスポンスにフィールドを追加
  ✓ オプショナルなリクエストパラメータの追加
  ✓ 新しいエンドポイントの追加
  ✓ エラーメッセージの文言変更
  ✓ パフォーマンス改善

破壊的変更（バージョンアップ必要）:
  ✗ レスポンスからフィールドを削除
  ✗ フィールドの型変更（string → number）
  ✗ 必須パラメータの追加
  ✗ エンドポイントの削除/リネーム
  ✗ ステータスコードの変更
  ✗ 認証方式の変更
  ✗ フィールド名の変更
  ✗ 列挙型の値の削除

グレーゾーン（慎重に判断）:
  ? デフォルト値の変更
  ? レスポンスフィールドの並び順変更
  ? エラーコードの追加
  → クライアント実装に依存
```

---

## 2. バージョニング方式

```
① URIバージョニング（最も一般的）:
  GET /api/v1/users
  GET /api/v2/users

  利点:
  ✓ 明示的でわかりやすい
  ✓ ブラウザやcurlで簡単にテスト
  ✓ CDN/プロキシでのルーティングが容易

  欠点:
  ✗ URLが変わるためリンクの更新が必要
  ✗ キャッシュキーが異なる

② ヘッダーバージョニング:
  GET /api/users
  Accept: application/vnd.example.v2+json

  利点:
  ✓ URLが変わらない
  ✓ RESTの原則に沿う（コンテンツネゴシエーション）

  欠点:
  ✗ ブラウザでテストしにくい
  ✗ 実装が複雑

③ クエリパラメータ:
  GET /api/users?version=2

  利点:
  ✓ 実装が簡単
  ✓ デフォルトバージョンを設定可能

  欠点:
  ✗ パラメータの汚染
  ✗ キャッシュキーに含めるか問題

推奨: URIバージョニング（/api/v1/）
  → シンプルで広く理解されている
  → メジャーバージョンのみ（v1, v2）
  → マイナー/パッチはバージョンアップしない
```

---

## 3. バージョン移行プロセス

```
非推奨化（Deprecation）の流れ:

  1. 告知（6ヶ月前）:
     → ドキュメントに非推奨を明記
     → レスポンスヘッダーで通知
     Deprecation: true
     Sunset: Sat, 01 Jul 2025 00:00:00 GMT
     Link: <https://api.example.com/v2/docs>; rel="successor-version"

  2. 警告期間（3ヶ月）:
     → ログで旧バージョンの使用状況を監視
     → 主要なクライアントに個別通知
     → 移行ガイドを提供

  3. ソフトシャットダウン:
     → レート制限を徐々に厳しく
     → レスポンスにマイグレーション案内を含める

  4. 完全終了:
     → 410 Gone を返す
     → 移行先APIへのリダイレクト情報を含める

移行ガイドの内容:
  → 変更点の一覧
  → 新旧フィールドのマッピング
  → コード例（before/after）
  → FAQ
  → サポート連絡先

並行稼働期間:
  → 最低12ヶ月（v1とv2を同時に運用）
  → エンタープライズAPIは24ヶ月以上
```

---

## 4. バージョンレス設計

```
バージョンレスAPI（進化的設計）:
  → バージョンを持たない設計
  → 常に後方互換を保つ

手法:
  ① additive changes only:
     → フィールドの追加のみ（削除/変更しない）
     → クライアントは未知のフィールドを無視する（Robustness Principle）

  ② Feature flags:
     → 新機能をフラグで制御
     GET /api/users?include=newField

  ③ フィールド選択:
     → クライアントが必要なフィールドを指定
     GET /api/users?fields=id,name,email

  ④ Content negotiation:
     Accept: application/vnd.example+json; version=2024-01

  バージョンレスの例: Stripe API
  → 日付ベースのバージョン: 2024-01-15
  → Stripe-Version ヘッダーで指定
  → 古い日付のクライアントは古い挙動を維持
  → 新規アカウントは最新バージョン
```

---

## まとめ

| 概念 | ポイント |
|------|---------|
| 破壊的変更 | フィールド削除、型変更、必須追加 |
| URIバージョニング | /api/v1/ が最も一般的で推奨 |
| 非推奨化 | 6ヶ月前告知 → 12ヶ月並行 → 終了 |
| バージョンレス | Additive only + Feature flags |

---

## 次に読むべきガイド
→ [[03-pagination-and-filtering.md]] — ページネーションとフィルタリング

---

## 参考文献
1. Stripe. "API Versioning." stripe.com/docs, 2024.
2. RFC 8594. "The Sunset HTTP Header Field." IETF, 2019.
