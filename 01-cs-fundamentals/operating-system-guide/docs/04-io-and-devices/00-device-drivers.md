# デバイスドライバ

> デバイスドライバは「ハードウェアの方言をOSの共通語に翻訳する」通訳者である。

## この章で学ぶこと

- [ ] デバイスドライバの役割を理解する
- [ ] キャラクタデバイスとブロックデバイスの違いを知る
- [ ] ドライバの基本的な仕組みを知る

---

## 1. デバイスドライバの基本

```
デバイスドライバの位置:

  アプリケーション
     │ read("/dev/sda", ...)
     ↓
  VFS / システムコール
     │
     ↓
  デバイスドライバ ←── ハードウェア固有のコード
     │
     ↓
  ハードウェア（ディスク、NIC、GPU等）

デバイスの種類:

  1. キャラクタデバイス（文字デバイス）:
     バイトストリームとして逐次アクセス
     → キーボード、マウス、シリアルポート、端末
     → /dev/tty, /dev/random, /dev/null

  2. ブロックデバイス:
     固定サイズのブロック単位でランダムアクセス
     → HDD、SSD、USBメモリ
     → /dev/sda, /dev/nvme0n1

  3. ネットワークデバイス:
     パケット単位の送受信
     → ファイルとしては表現されない
     → eth0, wlan0（ifconfig/ip で管理）

Linuxカーネルモジュール:
  ドライバを動的にロード/アンロード可能
  → 全デバイスのドライバをカーネルに組み込む必要なし

  $ lsmod                    # ロード済みモジュール一覧
  $ modprobe nvidia          # NVIDIAドライバをロード
  $ rmmod nvidia             # アンロード
  $ dmesg | tail             # カーネルメッセージ（ドライバのログ）
```

---

## 2. I/O制御方式

```
1. ポーリング（Programmed I/O）:
   CPUがデバイスの状態を繰り返しチェック
   → while (!device_ready()) { /* busy wait */ }
   → CPUを無駄に消費。単純なデバイスのみ

2. 割り込み（Interrupt-driven I/O）:
   デバイスが完了時にCPUに通知
   → CPUは他の仕事をしながら待てる
   → 割り込みハンドラで処理

   CPU ────────────○──────── ←割り込み発生
     ↑              │
     │ 他の仕事      │ ハンドラ実行
     └──────────────┘

3. DMA（Direct Memory Access）:
   デバイスが直接メモリにデータ転送
   → CPUを介さない → 大量データ転送に最適
   → ディスク、NICで使用

   CPU: 「ここにデータを書け」→ DMAコントローラ
   DMA: デバイス → メモリ（CPUは別の仕事）
   DMA: 「完了」→ 割り込みでCPUに通知
```

---

## 実践演習

### 演習1: [基礎] — デバイスの確認

```bash
# デバイスファイルの確認
ls -la /dev/sd*              # ブロックデバイス
ls -la /dev/tty*             # キャラクタデバイス
ls -la /dev/null /dev/zero /dev/random

# デバイス情報
lsblk                       # ブロックデバイスのツリー
lspci                       # PCIデバイス一覧
lsusb                       # USBデバイス一覧
```

---

## まとめ

| 概念 | ポイント |
|------|---------|
| キャラクタデバイス | バイトストリーム。逐次アクセス |
| ブロックデバイス | ブロック単位。ランダムアクセス |
| 割り込み | デバイス完了通知。CPUを解放 |
| DMA | CPU介さずメモリ転送。高速大量データ |

---

## 次に読むべきガイド
→ [[01-interrupts-dma.md]] — 割り込みとDMA

---

## 参考文献
1. Corbet, J. et al. "Linux Device Drivers." 3rd Ed, O'Reilly, 2005.
