# 仮想マシンの基礎

> 仮想化は「1台の物理マシン上で複数の独立した仮想マシンを実行する」技術であり、クラウドコンピューティングの基盤。

## この章で学ぶこと

- [ ] 仮想化の種類を区別できる
- [ ] ハイパーバイザの仕組みを理解する
- [ ] 主要な仮想化技術を知る

---

## 1. 仮想化の種類

```
1. 完全仮想化（Full Virtualization）:
   ゲストOSを無修正で実行
   → ハードウェアをソフトウェアでエミュレート
   → バイナリ変換 or ハードウェア支援（VT-x/AMD-V）

2. 準仮想化（Paravirtualization）:
   ゲストOSを仮想環境向けに修正
   → ハイパーコール（直接ハイパーバイザに要求）
   → 完全仮想化より高速
   → Xen が先駆け

3. ハードウェア支援仮想化:
   CPUに仮想化命令を搭載
   → Intel VT-x, AMD-V
   → ゲストOSの無修正実行 + 高性能
   → 現代の主流

ハイパーバイザの種類:
  Type 1（ベアメタル）:
  ┌──────┐ ┌──────┐
  │ VM 1 │ │ VM 2 │
  └──┬───┘ └──┬───┘
  ┌──┴────────┴───┐
  │ Hypervisor    │  ← ハードウェア上に直接
  └───────────────┘
  │ Hardware      │
  例: VMware ESXi, Xen, KVM, Hyper-V

  Type 2（ホスト型）:
  ┌──────┐ ┌──────┐
  │ VM 1 │ │ VM 2 │
  └──┬───┘ └──┬───┘
  ┌──┴────────┴───┐
  │ Hypervisor    │  ← ホストOS上のアプリ
  ├───────────────┤
  │ Host OS       │
  └───────────────┘
  例: VirtualBox, VMware Workstation, Parallels

  KVM（Linux）:
  Linuxカーネルモジュールとして動作
  → LinuxをType 1ハイパーバイザに変える
  → AWS EC2, Google Cloud の基盤
```

---

## 2. 仮想化のオーバーヘッド

```
パフォーマンスへの影響:

  CPU:    ほぼネイティブ（VT-x/AMD-Vで2-5%のオーバーヘッド）
  メモリ: EPT/NPT（拡張ページテーブル）で5-10%
  I/O:    最も大きなオーバーヘッド
          → virtio (準仮想化ドライバ)で改善
          → SR-IOV (デバイスを直接パススルー)で最小化

  SR-IOV（Single Root I/O Virtualization）:
  1つの物理NICを複数の仮想NICに分割
  → ハイパーバイザを経由せず直接アクセス
  → ほぼネイティブのネットワーク性能

メモリ効率化:
  KSM（Kernel Same-page Merging）:
  同一内容のメモリページを共有
  → 同じOSのVMが多い場合に効果的

  メモリバルーニング:
  ゲストOSの未使用メモリをホストが回収
  → メモリのオーバーコミットを実現
```

---

## 3. クラウドの仮想化

```
クラウドインスタンスの仕組み:

  ユーザー → API → コントロールプレーン
                         │
                    ┌─────┴─────┐
                    │ スケジューラ│
                    └─────┬─────┘
                          │ VMの配置先を決定
                    ┌─────┴─────┐
                    │ 物理サーバー│
                    │ KVM + QEMU │
                    │ ┌───┐┌───┐│
                    │ │VM1││VM2││
                    │ └───┘└───┘│
                    └───────────┘

  ライブマイグレーション:
  VMを停止せずに別の物理サーバーに移動
  1. メモリをコピー（稼働中に差分転送）
  2. 最終的に短時間停止してCPU状態を転送
  3. 新サーバーで再開（ダウンタイム数十ms）
  → ハードウェアメンテナンス時に活用
```

---

## まとめ

| 概念 | ポイント |
|------|---------|
| Type 1 | ベアメタル。KVM, ESXi。クラウドの基盤 |
| Type 2 | ホスト型。VirtualBox。開発環境 |
| VT-x/AMD-V | ハードウェア支援。ほぼネイティブ性能 |
| SR-IOV | デバイスの直接パススルー |

---

## 次に読むべきガイド
→ [[01-containers.md]] — コンテナ技術

---

## 参考文献
1. Portnoy, M. "Virtualization Essentials." 2nd Ed, Sybex, 2016.
