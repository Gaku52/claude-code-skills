# ブロックチェーン入門

> ブロックチェーンは「信頼の問題」をテクノロジーで解決する — 中央管理者なしに全員が合意できる仕組み。

## この章で学ぶこと

- [ ] ブロックチェーンの仕組みを技術的に理解する
- [ ] コンセンサスメカニズムの違いを説明できる
- [ ] スマートコントラクトの概念を知る

---

## 1. ブロックチェーンとは何か

```
従来の中央集権型 vs ブロックチェーン:

  中央集権型（銀行、SNS等）:
  ┌──────┐
  │中央DB │  ← 管理者が全権限を持つ
  └──┬───┘
  ┌──┼──┐
  A  B  C    ← ユーザーは管理者を信頼する

  問題:
  - 管理者の不正・改ざんリスク
  - 単一障害点（中央DBが落ちれば全停止）
  - 検閲のリスク

  ブロックチェーン:
  ┌───┐  ┌───┐  ┌───┐  ┌───┐
  │ A │──│ B │──│ C │──│ D │
  └───┘  └───┘  └───┘  └───┘
    │      │      │      │
   同じ台帳のコピーを全員が保持

  特徴:
  - 分散: 全参加者がデータのコピーを保持
  - 改ざん耐性: 過去のデータの変更が計算上不可能
  - 透明性: 全取引が公開・検証可能
  - 非中央集権: 管理者不要でシステムが稼働
```

---

## 2. ブロックの構造

```
ブロックチェーン = ブロックの連鎖（Linked List + ハッシュ）

  Block N-1          Block N            Block N+1
  ┌──────────┐      ┌──────────┐      ┌──────────┐
  │Header    │      │Header    │      │Header    │
  │ prevHash │←─────│ prevHash │←─────│ prevHash │
  │ timestamp│      │ timestamp│      │ timestamp│
  │ nonce    │      │ nonce    │      │ nonce    │
  │ merkleRoot│     │ merkleRoot│     │ merkleRoot│
  ├──────────┤      ├──────────┤      ├──────────┤
  │Body      │      │Body      │      │Body      │
  │ Tx1      │      │ Tx1      │      │ Tx1      │
  │ Tx2      │      │ Tx2      │      │ Tx2      │
  │ ...      │      │ ...      │      │ ...      │
  └──────────┘      └──────────┘      └──────────┘

  各フィールドの意味:
  - prevHash:    前のブロックのハッシュ → チェーンの連結
  - timestamp:   ブロック生成時刻
  - nonce:       PoWの解（マイニング結果）
  - merkleRoot:  全トランザクションのハッシュ木の根
  - Tx:          トランザクション（取引記録）

改ざん耐性の仕組み:

  Block 100のTx1を改ざんしたい場合:
  1. Tx1を変更 → merkleRoot が変わる
  2. Block 100のハッシュが変わる
  3. Block 101のprevHashと不一致
  4. Block 101も再計算が必要
  5. Block 102, 103, ... も全て再計算が必要
  6. さらにPoWの再計算（膨大な計算コスト）
  7. かつ、ネットワークの過半数を超える計算力が必要
  → 実質的に不可能
```

### マークル木（Merkle Tree）

```
トランザクションのハッシュを効率的に検証する構造

              Root Hash
            /           \
       Hash(AB)       Hash(CD)
       /     \        /     \
   Hash(A) Hash(B) Hash(C) Hash(D)
     │       │       │       │
    Tx A    Tx B    Tx C    Tx D

  利点:
  - 特定のTxが含まれているか効率的に検証（O(log n)）
  - 軽量ノード（SPV）: 全ブロックを保持せずに検証可能
  - 2つのデータセットの差分を効率的に検出

  検証例: Tx Bが含まれるか確認するには
  → Hash(B), Hash(A), Hash(CD) の3つだけ必要
  → 全トランザクションをダウンロードする必要なし
```

---

## 3. コンセンサスメカニズム

```
問題: 中央管理者なしで全ノードが同じ台帳に合意するには？

ビザンチン将軍問題:
  4人の将軍が攻撃/撤退を合意したい
  ただし1人は裏切り者で嘘のメッセージを送る
  → 正直な将軍だけで正しい合意を得る方法は？

  ブロックチェーンのコンセンサスはこの問題の実用的解法
```

### Proof of Work (PoW)

```
計算パズルを最初に解いたノードがブロックを追加する権利を得る

  パズル:
  SHA-256(header + nonce) < target
  → ハッシュ値の先頭にN個のゼロが並ぶnonceを見つける

  例: target = "0000..."（先頭4ゼロ）
  nonce=0: "a3f2b1..." → ✗
  nonce=1: "7c4e9d..." → ✗
  nonce=2: "00001f..." → ✗
  ...
  nonce=74839: "00009ab..." → ✗
  nonce=74840: "0000038..." → ✓ ブロック生成！

  特性:
  - 解を見つけるのは困難（ブルートフォース）
  - 解の検証は容易（ハッシュ1回計算するだけ）
  - 難易度は動的に調整（Bitcoin: 約10分/ブロック）

  Bitcoin のエネルギー消費:
  年間: 約100〜150 TWh（アルゼンチン1国分）
  → 環境問題として批判される

  51%攻撃:
  全体の51%以上の計算力を持つと改ざん可能
  → Bitcoinでは天文学的コストで現実的に不可能
  → 小規模チェーンでは実際に発生事例あり
```

### Proof of Stake (PoS)

```
保有トークン量に応じてブロック生成権を得る

  PoWとの比較:
  ┌────────────┬──────────────┬──────────────┐
  │            │ PoW          │ PoS          │
  ├────────────┼──────────────┼──────────────┤
  │ 資源       │ 計算力(電力) │ ステーク(資産)│
  │ 報酬       │ マイニング報酬│ ステーキング報酬│
  │ エネルギー │ 膨大         │ 極小         │
  │ 攻撃コスト │ 51%の計算力  │ 33%のステーク│
  │ 採用例     │ Bitcoin      │ Ethereum 2.0 │
  └────────────┴──────────────┴──────────────┘

  Ethereum の PoS (The Merge, 2022):
  - バリデータは32ETHをステーク
  - ランダムに選ばれたバリデータがブロックを提案
  - 他のバリデータが検証・投票
  - 不正行為 → ステークが没収（Slashing）
  - エネルギー消費が99.95%削減

  Nothing-at-Stake問題:
  PoSではフォーク時に両方に投票できる（計算コストなし）
  → Casper FFG / Slashing条件で対策
```

### その他のコンセンサス

```
3. DPoS（Delegated PoS）:
   トークン保有者が代表者に投票 → 代表者がブロック生成
   → 高速だが中央集権化のリスク
   例: EOS, Tron

4. BFT系（PBFT, Tendermint）:
   ノード間の投票で合意（2/3以上の合意で確定）
   → 確定が速い（ファイナリティ）
   → ノード数に制限あり（数十〜数百）
   例: Cosmos (Tendermint), Hyperledger Fabric

5. PoA（Proof of Authority）:
   承認されたバリデータのみがブロック生成
   → プライベートチェーン向け
   例: VeChain, テストネット

  比較:
  ┌──────────┬──────────┬──────────┬──────────┐
  │ メカニズム│ 速度     │ 分散性   │ 環境     │
  ├──────────┼──────────┼──────────┼──────────┤
  │ PoW      │ 遅い     │ 高い     │ 悪い     │
  │ PoS      │ 中程度   │ 高い     │ 良い     │
  │ DPoS     │ 速い     │ 中程度   │ 良い     │
  │ BFT      │ 速い     │ 低い     │ 良い     │
  │ PoA      │ 非常に速い│ 低い    │ 良い     │
  └──────────┴──────────┴──────────┴──────────┘
```

---

## 4. 暗号技術の基盤

```
ブロックチェーンを支える暗号技術:

  1. ハッシュ関数（SHA-256）:
     任意のデータ → 固定長のハッシュ値
     - 一方向性: ハッシュから元データを復元不可
     - 衝突耐性: 同じハッシュになる2つのデータを見つけるのは困難
     - 雪崩効果: 1ビットの変更でハッシュ全体が変化

     "Hello"  → 185f8db32271...
     "Hello!" → 334d016f7558...  ← 完全に異なる

  2. 公開鍵暗号（楕円曲線暗号 / ECDSA）:
     秘密鍵（知っているのは自分だけ）
       → 公開鍵（全世界に公開）
         → アドレス（取引の宛先）

     秘密鍵 ──[一方向計算]──→ 公開鍵 ──[ハッシュ]──→ アドレス
     (復元不可)              (復元不可)

     署名の仕組み:
     送信者: 秘密鍵でトランザクションに署名
     検証者: 公開鍵で署名を検証 → 本人確認

  3. マークル木:
     前述の通り、トランザクションの効率的な検証

  ウォレット:
  秘密鍵を管理するソフトウェア/ハードウェア
  - ホットウォレット: インターネット接続（MetaMask等）
  - コールドウォレット: オフライン保管（Ledger等）
  - 秘密鍵を失うと資産は永久に失われる
```

---

## 5. スマートコントラクト

```
スマートコントラクト:
  ブロックチェーン上で自動実行されるプログラム

  「もし条件Xが満たされたら、処理Yを実行する」
  → 中間者なしで契約が自動執行される

  例: 簡単なスマートコントラクト（Solidity）

  // SPDX-License-Identifier: MIT
  pragma solidity ^0.8.0;

  contract SimpleEscrow {
      address public buyer;
      address public seller;
      uint public amount;
      bool public confirmed;

      constructor(address _seller) payable {
          buyer = msg.sender;
          seller = _seller;
          amount = msg.value;
      }

      // 買い手が商品受取を確認 → 自動で売り手に送金
      function confirmReceived() public {
          require(msg.sender == buyer, "Only buyer");
          require(!confirmed, "Already confirmed");
          confirmed = true;
          payable(seller).transfer(amount);
      }
  }

  特性:
  - 不可逆: デプロイ後のコード変更不可（upgradableパターンは存在）
  - 透明性: コードが公開されており誰でも検証可能
  - 自動実行: 条件が満たされれば人の介入なしに実行
  - ガスコスト: 実行に計算手数料（ガス代）が必要
```

### Ethereumの仕組み

```
Ethereum = ブロックチェーン + スマートコントラクト実行環境

  EVM（Ethereum Virtual Machine）:
  全ノードが同じ仮想マシンでコードを実行
  → 結果が全ノードで一致（決定的実行）

  アカウントモデル:
  ┌──────────────────────────────┐
  │ EOA（外部所有アカウント）     │
  │ = 人間が秘密鍵で操作         │
  │ - アドレス, 残高, nonce      │
  ├──────────────────────────────┤
  │ Contract Account             │
  │ = スマートコントラクト        │
  │ - アドレス, 残高, コード      │
  │ - ストレージ（永続データ）    │
  └──────────────────────────────┘

  ガス（Gas）:
  計算量に応じた手数料
  - 送金: 21,000 gas
  - ERC-20トークン送信: 約65,000 gas
  - Uniswapスワップ: 約150,000 gas
  - ガス価格はネットワーク混雑度で変動

  Layer 2 スケーリング:
  メインチェーン（L1）の処理能力限界を克服

  ┌─────────────────────────────┐
  │ Layer 2                      │
  │ (Optimistic Rollup / ZK Rollup) │
  │ 高速・低コストで処理          │
  └────────────┬────────────────┘
               │ 定期的にL1に記録
  ┌────────────┴────────────────┐
  │ Layer 1 (Ethereum Mainnet)   │
  │ セキュリティ・最終確定性     │
  └──────────────────────────────┘

  Optimistic Rollup: 不正証明で検証（Arbitrum, Optimism）
  ZK Rollup: ゼロ知識証明で検証（zkSync, StarkNet）
```

---

## 6. DeFiとトークン

```
DeFi（分散型金融）:
  銀行なしで金融サービスを提供

  主要プロトコル:
  ┌──────────────────────────────────────────┐
  │ DEX（分散型取引所）:                      │
  │ Uniswap: AMM（自動マーケットメイカー）    │
  │ x × y = k の数式でトークン交換レートを決定│
  │                                          │
  │ レンディング:                             │
  │ Aave, Compound: 暗号資産の貸し借り        │
  │                                          │
  │ ステーブルコイン:                         │
  │ USDC: 法定通貨担保型（1:1でドル裏付け）   │
  │ DAI: 暗号資産担保型（過剰担保で安定）     │
  └──────────────────────────────────────────┘

  トークン標準（Ethereum）:
  - ERC-20:  代替可能トークン（通貨、ガバナンス）
  - ERC-721: NFT（非代替性トークン）
  - ERC-1155: マルチトークン（ゲームアイテム等）

  NFT（Non-Fungible Token）:
  デジタル所有権の証明
  → アート、ゲームアイテム、チケット、不動産トークン化
  → 実際の価値は用途による（投機バブルの批判あり）
```

---

## 7. ブロックチェーンの限界と課題

```
トリレンマ（Vitalik Buterin）:
3つの性質のうち、同時に2つしか達成できない

  分散性 ────── セキュリティ
     \           /
      \         /
       \       /
     スケーラビリティ

  Bitcoin:   分散性✓ セキュリティ✓ スケーラビリティ✗（7 TPS）
  Ethereum:  分散性✓ セキュリティ✓ スケーラビリティ✗（15 TPS）
  Solana:    スケーラビリティ✓ セキュリティ✓ 分散性△
  Visa:      65,000 TPS（中央集権）

技術的課題:
  1. スケーラビリティ: TPS（秒間トランザクション数）の限界
     → L2, シャーディングで対応

  2. エネルギー消費: PoWの膨大な電力消費
     → PoSへの移行で解決傾向

  3. 秘密鍵管理: 紛失 = 資産喪失
     → マルチシグ、ソーシャルリカバリ、MPC

  4. スマートコントラクトの脆弱性:
     - 再入攻撃（The DAO事件, 2016: $60M被害）
     - フラッシュローン攻撃
     - オラクル操作
     → 形式検証、監査の重要性

  5. 規制の不確実性:
     各国で法規制が異なり変化も激しい

社会的課題:
  - 投機とバブル（価格の極端な変動）
  - マネーロンダリングのリスク
  - 環境への影響
  - 真に分散化されているか？（マイニングプールの寡占）
```

---

## 実践演習

### 演習1: [基礎] — ブロックチェーンの手動シミュレーション

```
以下のブロックチェーンを手動で構築せよ:

ハッシュ関数: 簡易版として文字列の文字数を使用
（実際のSHA-256の代わり）

1. Genesisブロック（最初のブロック）を作成:
   prevHash: "0"
   data: "Alice→Bob: 10BTC"
   hash: hash(prevHash + data)

2. Block 1を作成:
   prevHash: Genesisのhash
   data: "Bob→Charlie: 5BTC"

3. Block 2を作成:
   prevHash: Block 1のhash
   data: "Charlie→Alice: 3BTC"

4. Block 1のdataを改ざんするとどうなるか説明せよ
```

### 演習2: [応用] — PoWのシミュレーション

```python
# 以下のコードを完成させ、PoWマイニングを体験せよ

import hashlib

def mine_block(data, prev_hash, difficulty):
    """
    difficulty: ハッシュ先頭のゼロの数
    戻り値: (nonce, hash)
    """
    target = "0" * difficulty
    nonce = 0
    while True:
        text = f"{prev_hash}{data}{nonce}"
        hash_result = hashlib.sha256(text.encode()).hexdigest()
        if hash_result[:difficulty] == target:
            return nonce, hash_result
        nonce += 1

# difficulty を 1, 2, 3, 4 と変えて実行時間を比較せよ
# それぞれのnonce値と計算時間を記録せよ
```

### 演習3: [発展] — スマートコントラクト設計

```
以下の要件を満たすスマートコントラクトを擬似コードで設計せよ:

「分散型クラウドファンディング」

要件:
- 目標金額と期限を設定できる
- 期限内に目標達成 → 資金をプロジェクトオーナーに送金
- 期限内に目標未達 → 出資者に全額返金
- 各出資者の出資額を記録
- オーナーは目標達成前に資金を引き出せない

考慮すべき攻撃パターン:
- 再入攻撃
- フロントランニング
- 整数オーバーフロー
```

---

## FAQ

### Q1: ブロックチェーンはどんな問題に適しているのか？

適している場面:
- **複数の利害関係者**が関わるデータ管理（サプライチェーン）
- **改ざん耐性**が求められる記録（不動産登記、学位証明）
- **仲介者を排除**したい取引（国際送金、DeFi）
- **透明性**が求められるプロセス（投票、寄付）

適していない場面:
- 単一組織内のデータ管理（通常のDBで十分）
- 高速な処理が必要（数千TPS以上）
- プライバシーが最重要（パブリックチェーンは全データ公開）

### Q2: Bitcoinの「半減期」とは何か？

マイニング報酬が約4年ごとに半分になる仕組み:
- 2009年: 50 BTC/ブロック → 2012年: 25 → 2016年: 12.5 → 2020年: 6.25 → 2024年: 3.125
- 総発行量は2100万BTCで上限（2140年頃に全発行完了）
- 供給量の減少により希少性が増す（デフレ的性質）

### Q3: プライベートチェーンとパブリックチェーンの違いは？

| 特性 | パブリック | プライベート |
|------|----------|------------|
| 参加 | 誰でも | 許可制 |
| 透明性 | 完全公開 | 参加者のみ |
| 速度 | 遅い | 速い |
| 分散性 | 高い | 低い |
| 例 | Bitcoin, Ethereum | Hyperledger, Corda |

エンタープライズ用途ではプライベート/コンソーシアムチェーンが多い。ただし「プライベートチェーンは単なる分散DBでは？」という批判もある。

---

## まとめ

| 概念 | ポイント |
|------|---------|
| ブロックチェーン | ハッシュチェーン + P2P + コンセンサスで改ざん耐性 |
| PoW / PoS | 計算力 vs ステーク。PoSが主流に移行中 |
| スマートコントラクト | 自動実行プログラム。EVM上で動作 |
| DeFi | 銀行なしの金融サービス。DEX, レンディング |
| 課題 | トリレンマ(分散・安全・速度)、エネルギー、規制 |

---

## 次に読むべきガイド
→ [[03-future-of-cs.md]] — コンピュータサイエンスの未来

---

## 参考文献
1. Nakamoto, S. "Bitcoin: A Peer-to-Peer Electronic Cash System." 2008.
2. Buterin, V. "Ethereum Whitepaper." 2014.
3. Antonopoulos, A. "Mastering Bitcoin." O'Reilly, 2017.
4. Antonopoulos, A. & Wood, G. "Mastering Ethereum." O'Reilly, 2018.
