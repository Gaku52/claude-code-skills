# システム設計入門

> システム設計は「正解のない」問題であり、トレードオフの中で最善の選択をする技術である。

## この章で学ぶこと

- [ ] スケーラビリティの基本概念を理解する
- [ ] CAP定理を説明できる
- [ ] 主要なシステム設計パターンを知る

---

## 1. スケーラビリティ

```
スケールの2つの方向:

  垂直スケーリング（スケールアップ）:
  → マシンを強化（CPU, RAM追加）
  → 限界あり、ダウンタイムが発生
  → 単純だが高価

  水平スケーリング（スケールアウト）:
  → マシンを追加
  → 理論上無限にスケール
  → 複雑だがコスト効率が良い

  典型的なWebアーキテクチャ:
  ┌────────┐   ┌──────────────┐   ┌──────────┐
  │ Client │──→│ Load Balancer│──→│ Web x N  │
  └────────┘   └──────────────┘   └────┬─────┘
                                       │
                              ┌────────┼────────┐
                              ▼        ▼        ▼
                          ┌──────┐ ┌──────┐ ┌──────┐
                          │Cache │ │ DB   │ │Queue │
                          │Redis │ │Master│ │SQS   │
                          └──────┘ │Slave │ └──────┘
                                   └──────┘
```

---

## 2. CAP定理

```
CAP定理: 分散システムは3つのうち2つしか同時に保証できない

  C — Consistency（一貫性）: 全ノードが同時に同じデータを見る
  A — Availability（可用性）: 全リクエストがレスポンスを返す
  P — Partition Tolerance（分断耐性）: ネットワーク分断でも動作

  ネットワーク分断は避けられない → 実質 CP or AP の選択

  CP（一貫性優先）: 分断時にエラーを返す
  → 銀行送金、在庫管理
  → PostgreSQL, MongoDB(デフォルト), ZooKeeper

  AP（可用性優先）: 分断時に古いデータを返す可能性
  → SNSのタイムライン、ショッピングカート
  → Cassandra, DynamoDB, CouchDB

  PACELC定理（CAP拡張）:
  分断時(P): AかCを選択
  通常時(E): Latency(L)かConsistency(C)を選択
```

---

## 3. 主要な設計パターン

```
システム設計の定番パターン:

  1. キャッシング
     → CDN, Redis, ブラウザキャッシュ
     → Read Heavy なシステムの定番

  2. メッセージキュー
     → SQS, RabbitMQ, Kafka
     → 非同期処理、マイクロサービス間通信

  3. データベースシャーディング
     → データを複数のDBに分散
     → ユーザーID % N でシャードを決定

  4. マイクロサービス
     → 独立したサービスに分割
     → 独立デプロイ、技術選択の自由
     → 運用複雑性が増大（分散システムの難しさ）

  5. イベント駆動アーキテクチャ
     → イベントを発行/購読
     → 疎結合、スケーラブル
```

---

## 4. 数字で考える

```
システム設計の概算:

  DAU 100万人のSNS:
  - ピークQPS: 100万 / 86400 × 3 ≈ 35 QPS (書込)
  - 読み取りQPS: 35 × 100 = 3,500 QPS
  - 1台のWebサーバー: 1,000〜10,000 QPS → 1-4台で足りる
  - DBは読み取りレプリカ + キャッシュで対応可能

  DAU 1億人:
  - 書込QPS: 3,500
  - 読み取りQPS: 350,000
  - Webサーバー: 数十台
  - DBシャーディング必須
  - CDN + Redis 必須
```

---

## まとめ

| 概念 | ポイント |
|------|---------|
| スケーリング | 垂直(強化) vs 水平(追加)。水平が主流 |
| CAP定理 | CP(一貫性) vs AP(可用性)。用途で選択 |
| キャッシュ | 読み取り性能の定番改善策 |
| メッセージキュー | 非同期処理。サービス間の疎結合 |

---

## 次に読むべきガイド
→ [[05-version-control.md]] — バージョン管理

---

## 参考文献
1. Kleppmann, M. "Designing Data-Intensive Applications." O'Reilly, 2017.
2. Alex Xu. "System Design Interview." 2020.
