# マザーボードとバス

> マザーボードはコンピュータの「神経系」であり、全てのコンポーネント間の通信を司る。

## この章で学ぶこと

- [ ] マザーボードの主要コンポーネントと役割を説明できる
- [ ] バスアーキテクチャの進化を理解する
- [ ] ブートプロセスの各段階を説明できる

## 前提知識

- CPUとメモリの基礎 → 参照: [[00-cpu-architecture.md]], [[01-memory-hierarchy.md]]

---

## 1. マザーボードの構成要素

```
マザーボードのレイアウト（概念図）:

  ┌──────────────────────────────────────────────────┐
  │  ┌──────────┐          ┌──────────────────────┐ │
  │  │ CPU      │←────────→│ メモリスロット       │ │
  │  │ ソケット │ メモリバス │ DIMM1 DIMM2 DIMM3  │ │
  │  └────┬─────┘          └──────────────────────┘ │
  │       │                                          │
  │       │ PCIe x16                                 │
  │       ▼                                          │
  │  ┌──────────────────────────────────┐            │
  │  │       PCH (Platform Controller Hub)│           │
  │  │  ┌─────────────────────────────┐  │           │
  │  │  │ PCIe x4 → NVMe SSD スロット │  │           │
  │  │  │ PCIe x16 → GPU スロット     │  │           │
  │  │  │ SATA → HDD/SSD              │  │           │
  │  │  │ USB 3.x/4.0 コントローラ    │  │           │
  │  │  │ Ethernet コントローラ        │  │           │
  │  │  │ Audio コントローラ           │  │           │
  │  │  │ Wi-Fi/Bluetooth              │  │           │
  │  │  └─────────────────────────────┘  │           │
  │  └──────────────────────────────────┘            │
  │                                                   │
  │  ┌──────────┐  ┌──────────┐  ┌──────────────┐  │
  │  │ BIOS/UEFI│  │ 電源      │  │ I/Oポート    │  │
  │  │ (SPI     │  │ コネクタ  │  │ USB,HDMI,    │  │
  │  │  Flash)  │  │ (ATX)     │  │ Ethernet...  │  │
  │  └──────────┘  └──────────┘  └──────────────┘  │
  └──────────────────────────────────────────────────┘
```

---

## 2. バスの種類と進化

### 2.1 バスの歴史

| 規格 | 年代 | 帯域幅 | 特徴 |
|------|------|--------|------|
| ISA | 1981 | 8 MB/s | IBM PC初期のバス |
| PCI | 1992 | 133 MB/s | 共有バス、プラグ&プレイ |
| AGP | 1997 | 2.1 GB/s | GPU専用バス |
| PCI Express 1.0 | 2003 | 250 MB/s/lane | ポイントtoポイント、レーン制 |
| PCIe 2.0 | 2007 | 500 MB/s/lane | 帯域2倍 |
| PCIe 3.0 | 2010 | 985 MB/s/lane | 128b/130bエンコーディング |
| PCIe 4.0 | 2017 | 1,969 MB/s/lane | NVMe SSDの標準 |
| PCIe 5.0 | 2019 | 3,938 MB/s/lane | サーバー、ハイエンド |
| PCIe 6.0 | 2022 | 7,877 MB/s/lane | PAM4、FEC必須 |

### 2.2 PCIe の構造

```
PCIe レーン構成:

  PCIe x1:  ──→  1レーン  =  3.9 GB/s (PCIe 5.0)
  PCIe x4:  ────→ 4レーン  = 15.8 GB/s (NVMe SSD)
  PCIe x8:  ────────→ 8レーン  = 31.5 GB/s
  PCIe x16: ────────────────→ 16レーン = 63.0 GB/s (GPU)

  各レーンは独立した送受信ペア（差動信号）:
  ┌──────┐         ┌──────┐
  │ CPU  │ ──TX──→ │ GPU  │  送信
  │      │ ←──RX── │      │  受信
  └──────┘         └──────┘
  → 全二重通信（同時送受信）
```

---

## 3. USB規格

### 3.1 USB規格比較

| 規格 | 年 | 速度 | 電力供給 | コネクタ |
|------|-----|------|---------|---------|
| USB 1.1 | 1998 | 12 Mbps | 2.5W | Type-A/B |
| USB 2.0 | 2000 | 480 Mbps | 2.5W | Type-A/B |
| USB 3.0 | 2008 | 5 Gbps | 4.5W | Type-A(青)/B |
| USB 3.1 Gen2 | 2013 | 10 Gbps | 100W (PD) | Type-C |
| USB 3.2 Gen2x2 | 2017 | 20 Gbps | 100W (PD) | Type-C |
| USB4 v1 | 2019 | 40 Gbps | 100W (PD) | Type-C |
| USB4 v2 | 2022 | 80 Gbps | 240W (EPR) | Type-C |
| Thunderbolt 5 | 2024 | 120 Gbps | 240W | Type-C |

### 3.2 USB Type-C の統一

```
USB Type-Cコネクタ（24ピン）:

  ┌─────────────────────────────────┐
  │ ● ● ● ● ● ● ● ● ● ● ● ● │ 上段12ピン
  │ ● ● ● ● ● ● ● ● ● ● ● ● │ 下段12ピン
  └─────────────────────────────────┘

  リバーシブル: どちら向きでも挿せる
  統合: USB、Thunderbolt、DisplayPort、電力供給を1本で

  ただし注意: Type-Cコネクタ ≠ USB4
  → 見た目は同じType-Cでも、USB 2.0の速度しか出ないケーブルもある
  → ケーブル/デバイスの仕様確認が重要
```

---

## 4. ブートプロセス

### 4.1 電源投入からOS起動まで

```
ブートプロセスの全段階:

  ┌──────────────┐
  │ 1. 電源投入   │ ← 電源ユニットがPower Good信号を送出
  └──────┬───────┘
         ▼
  ┌──────────────┐
  │ 2. リセット   │ ← CPUのリセットベクタ（0xFFFFFFF0）にジャンプ
  └──────┬───────┘
         ▼
  ┌──────────────┐
  │ 3. BIOS/UEFI │ ← SPIフラッシュからファームウェアをロード
  │    初期化    │    CPUキャッシュをRAMとして一時使用（CAR）
  └──────┬───────┘
         ▼
  ┌──────────────┐
  │ 4. POST      │ ← Power-On Self Test
  │    (自己診断)│    メモリ検出、デバイス初期化、エラーチェック
  └──────┬───────┘    ビープ音でエラー通知（メモリなし=連続ビープ等）
         ▼
  ┌──────────────┐
  │ 5. ブート     │ ← ブートデバイスを検索（NVMe→USB→Network）
  │    デバイス   │    UEFI: ESP (EFI System Partition) を探す
  │    選択      │    BIOS: MBRの先頭512バイトを読む
  └──────┬───────┘
         ▼
  ┌──────────────┐
  │ 6. ブート     │ ← GRUB, systemd-boot, Windows Boot Manager等
  │    ローダー  │    カーネルイメージとinitramfsをメモリにロード
  └──────┬───────┘
         ▼
  ┌──────────────┐
  │ 7. カーネル   │ ← ハードウェア初期化、ドライバーロード
  │    初期化    │    ルートファイルシステムのマウント
  └──────┬───────┘
         ▼
  ┌──────────────┐
  │ 8. init/     │ ← systemd (PID 1) がサービスを起動
  │    systemd   │    ネットワーク、ログ、GUI等
  └──────┬───────┘
         ▼
  ┌──────────────┐
  │ 9. ログイン   │ ← ユーザーの操作可能状態
  └──────────────┘

  所要時間: 数秒（NVMe + UEFI + SSD）〜数分（HDD + BIOS）
```

### 4.2 BIOS vs UEFI

| 項目 | BIOS (Legacy) | UEFI |
|------|-------------|------|
| 策定 | 1975年 (IBM PC) | 2007年 (Intel主導) |
| インターフェース | テキストベース | GUIサポート |
| ブートドライバ | 16ビット | 64ビット |
| パーティション | MBR (最大2TB) | GPT (最大8ZB) |
| セキュリティ | なし | Secure Boot |
| 起動速度 | 遅い | 高速 |
| ネットワーク | なし | PXEブート標準 |

---

## 5. チップセットアーキテクチャ

### 5.1 進化の歴史

```
旧式（2000年代）:
  ┌─────┐   FSB    ┌───────────┐   ┌──────┐
  │ CPU │←────────→│ノースブリッジ│──→│ GPU  │
  └─────┘          │(MCH)       │   └──────┘
                   └──────┬────┘
                          │
                   ┌──────┴────┐
                   │サウスブリッジ│──→ USB, SATA, Audio
                   │(ICH)       │
                   └───────────┘

現代（2020年代）:
  ┌──────────────────────┐
  │        CPU            │
  │  ┌──────────────────┐│
  │  │ メモリコントローラ ││──→ DDR5 RAM
  │  │ PCIe コントローラ  ││──→ GPU (PCIe x16)
  │  │                    ││──→ NVMe (PCIe x4)
  │  └──────────────────┘│
  └──────────┬───────────┘
             │ DMI 4.0 (〜8GB/s)
             ▼
  ┌──────────────────────┐
  │   PCH (Platform      │
  │   Controller Hub)    │──→ USB, SATA, Audio
  │                      │──→ Wi-Fi, Ethernet
  │                      │──→ 追加PCIeレーン
  └──────────────────────┘

  進化: ノースブリッジ機能がCPUに統合
  → メモリアクセスの高速化（バスのボトルネック除去）
  → GPU接続の低レイテンシ化
```

---

## 6. 最新トレンド

### 6.1 CXL（Compute Express Link）

```
CXL の3つのプロトコル:

  CXL.io   — PCIeベースのデバイスI/O（レガシー互換）
  CXL.cache — デバイスがホストメモリをキャッシュ
  CXL.mem   — ホストがデバイスメモリにアクセス

  応用例:
  ┌──────┐        CXL        ┌──────────────────┐
  │ CPU  │←──────────────────→│ CXL メモリ拡張    │
  └──────┘                    │ (DRAM増設、       │
                              │  不揮発メモリ)    │
                              └──────────────────┘
  → RAMをサーバー間で共有（メモリプーリング）
  → 従来不可能だったTB級メモリ空間を実現
```

### 6.2 チップレットアーキテクチャ

| アプローチ | 説明 | 例 |
|-----------|------|-----|
| モノリシック | 1枚の大きなダイ | Intel Core (旧世代) |
| チップレット | 複数の小ダイを接続 | AMD EPYC, Apple M2 Ultra |
| UCIe | チップレット間の標準規格 | Intel, AMD, ARM共同策定 |

→ 歩留まり向上、異なるプロセスノードの混在、柔軟なスケーリング。

---

## 7. 実践演習

### 演習1: スペックの読み方（基礎）

自分のPC/Macのスペックを調べ、以下を特定せよ:
1. CPUソケット/チップの種類
2. メモリの規格（DDR4/DDR5）、チャネル数、帯域幅
3. ストレージの接続方式（NVMe/SATA）
4. USBポートの種類と速度

### 演習2: ボトルネック分析（応用）

以下のシステムで、ボトルネックになりうる箇所を特定せよ:
- CPU: AMD Ryzen 9 7950X (16コア)
- RAM: DDR5-5200 64GB（デュアルチャネル）
- GPU: NVIDIA RTX 4090 (PCIe 4.0 x16)
- Storage: Samsung 990 Pro 2TB (PCIe 4.0 x4)
- ワークロード: 4K動画編集 + AI学習

### 演習3: ブートプロセスの観察（発展）

LinuxマシンでUEFIブートプロセスを観察せよ:
```bash
# ブートログの確認
journalctl -b | head -100

# UEFIブート変数の確認
efibootmgr -v

# PCIeデバイスの列挙
lspci -vvv | head -50

# USBデバイスの列挙
lsusb -t
```

---

## FAQ

### Q1: マザーボードの選び方は？

**A**: 以下の順で決める:
1. CPUソケット（Intel LGA1700、AMD AM5等）
2. チップセット（機能差: PCIeレーン数、USB数、オーバークロック対応）
3. フォームファクタ（ATX/mATX/Mini-ITX）
4. メモリスロット数とDDR世代
5. M.2/NVMeスロット数
6. 拡張性（PCIeスロット、USB、ネットワーク）

### Q2: Thunderbolt と USB4 の違いは？

**A**: Thunderbolt 4/5 は USB4 のスーパーセット:
- USB4: 最低20Gbps保証
- Thunderbolt 4: 40Gbps保証 + DP 2.0 + PCIeトンネリング
- Thunderbolt 5: 80-120Gbps + 240W給電

全てType-Cコネクタを使用するが、性能はケーブルとデバイスの対応次第。

### Q3: なぜPCIeは「レーン」単位なのですか？

**A**: 柔軟なスケーリングのため。デバイスの帯域要求に応じてレーン数を変えられる:
- NVMe SSD: x4で十分（〜8GB/s）
- GPU: x16で最大帯域（〜32GB/s）
- Wi-Fiカード: x1で十分（〜1GB/s）
マザーボード上のPCIeレーン数はCPU+チップセットで決まり、配分はBIOSで設定可能。

---

## まとめ

| 概念 | ポイント |
|------|---------|
| マザーボード | CPU、メモリ、PCH（チップセット）を接続する基盤 |
| PCIe | ポイントtoポイント、レーン制、世代ごとに帯域2倍 |
| USB | Type-Cに統一傾向、USB4/Thunderboltで高速化 |
| ブート | 電源→UEFI→POST→ブートローダー→カーネル→init |
| 進化 | ノースブリッジ→CPU統合、CXL、チップレット |

---

## 次に読むべきガイド

→ [[04-gpu-and-parallel.md]] — GPUと並列計算

---

## 参考文献

1. PCI-SIG. "PCI Express Base Specification." Various Revisions.
2. USB Implementers Forum. "Universal Serial Bus Specification." Various Revisions.
3. UEFI Forum. "Unified Extensible Firmware Interface Specification."
4. Intel. "Platform Controller Hub (PCH) Datasheets."
5. CXL Consortium. "Compute Express Link Specification." https://www.computeexpresslink.org/
