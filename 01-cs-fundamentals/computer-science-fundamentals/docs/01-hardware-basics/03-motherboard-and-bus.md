# マザーボードとバス

> マザーボードはコンピュータの「神経系」であり、全てのコンポーネント間の通信を司る。

## この章で学ぶこと

- [ ] マザーボードの主要コンポーネントと役割を説明できる
- [ ] バスアーキテクチャの進化を理解する
- [ ] ブートプロセスの各段階を説明できる
- [ ] PCIeの詳細仕様とレーン配分を理解する
- [ ] USB規格の進化と実務での選定基準を習得する
- [ ] サーバーアーキテクチャとの違いを説明できる

## 前提知識

- CPUとメモリの基礎 → 参照: [[00-cpu-architecture.md]], [[01-memory-hierarchy.md]]

---

## 1. マザーボードの構成要素

```
マザーボードのレイアウト（概念図）:

  ┌──────────────────────────────────────────────────┐
  │  ┌──────────┐          ┌──────────────────────┐ │
  │  │ CPU      │←────────→│ メモリスロット       │ │
  │  │ ソケット │ メモリバス │ DIMM1 DIMM2 DIMM3  │ │
  │  └────┬─────┘          └──────────────────────┘ │
  │       │                                          │
  │       │ PCIe x16                                 │
  │       ▼                                          │
  │  ┌──────────────────────────────────┐            │
  │  │       PCH (Platform Controller Hub)│           │
  │  │  ┌─────────────────────────────┐  │           │
  │  │  │ PCIe x4 → NVMe SSD スロット │  │           │
  │  │  │ PCIe x16 → GPU スロット     │  │           │
  │  │  │ SATA → HDD/SSD              │  │           │
  │  │  │ USB 3.x/4.0 コントローラ    │  │           │
  │  │  │ Ethernet コントローラ        │  │           │
  │  │  │ Audio コントローラ           │  │           │
  │  │  │ Wi-Fi/Bluetooth              │  │           │
  │  │  └─────────────────────────────┘  │           │
  │  └──────────────────────────────────┘            │
  │                                                   │
  │  ┌──────────┐  ┌──────────┐  ┌──────────────┐  │
  │  │ BIOS/UEFI│  │ 電源      │  │ I/Oポート    │  │
  │  │ (SPI     │  │ コネクタ  │  │ USB,HDMI,    │  │
  │  │  Flash)  │  │ (ATX)     │  │ Ethernet...  │  │
  │  └──────────┘  └──────────┘  └──────────────┘  │
  └──────────────────────────────────────────────────┘
```

### 1.1 マザーボードの主要コンポーネント詳解

```
各コンポーネントの詳細:

  ■ CPUソケット
    - Intel LGA (Land Grid Array): ピンがソケット側
      LGA1700 (12th-14th Gen), LGA1851 (Arrow Lake)
    - AMD PGA (Pin Grid Array): ピンがCPU側（AM4まで）
    - AMD LGA: AM5からLGAに移行
    - サーバー: LGA4094 (AMD SP5), LGA4677 (Intel)

    ソケットの互換性:
    ┌───────────────────────────────────────────┐
    │ プラットフォーム │ ソケット │ 世代            │
    │──────────────────│──────────│─────────────────│
    │ Intel Desktop    │ LGA1700  │ 12th-14th Gen   │
    │ Intel Desktop    │ LGA1851  │ Arrow Lake+     │
    │ AMD Desktop      │ AM4      │ Ryzen 1000-5000 │
    │ AMD Desktop      │ AM5      │ Ryzen 7000+     │
    │ Intel Server     │ LGA4677  │ Sapphire Rapids+ │
    │ AMD Server       │ SP5      │ EPYC 9004+      │
    └───────────────────────────────────────────┘

  ■ メモリスロット（DIMMスロット）
    - 通常2本または4本（デスクトップ）
    - サーバーでは8-12本/CPU
    - DDR5: 288ピン、デュアルチャネル（各チャネル32ビット）
    - DIMM種類:
      UDIMM: アンバッファード（デスクトップ）
      RDIMM: レジスタード（サーバー、ECC対応）
      LRDIMM: ロードリデュースト（大容量サーバー）
      SO-DIMM: ノートPC用（小型）

  ■ VRM (Voltage Regulator Module)
    - CPUに安定した電圧を供給
    - フェーズ数が多いほど安定（高性能マザーボードは16-20フェーズ）
    - オーバークロック時に特に重要
    - MOSFETの品質がVRMの品質を決定

    VRMの構成:
    ┌──────────────────────────────────────────┐
    │ 12V (ATX電源) → VRM → 1.1V (CPU VCore)  │
    │                                           │
    │ ┌─────┐ ┌─────┐ ┌─────┐    ┌──────┐  │
    │ │Phase│ │Phase│ │Phase│... │ CPU   │  │
    │ │ 1   │ │ 2   │ │ 3   │    │       │  │
    │ └─────┘ └─────┘ └─────┘    └──────┘  │
    │ PWMコントローラが各フェーズを交互に動作   │
    │ → 電流の安定化、発熱の分散               │
    └──────────────────────────────────────────┘

  ■ SPI フラッシュ（BIOS/UEFI ROM）
    - 容量: 16-32MB（UEFI + マイクロコード）
    - SPI (Serial Peripheral Interface) バスで接続
    - 電源投入時に最初に読まれるチップ
    - Dual BIOSの場合は2チップ搭載（障害対策）
```

### 1.2 フォームファクタ

```
マザーボードのフォームファクタ:

  ┌────────────────────────────────────────────────────┐
  │ ATX (305 × 244 mm)                                 │
  │ ┌──────────────────────────────────────────────┐  │
  │ │                                              │  │
  │ │  PCIe x16 × 2-3                             │  │
  │ │  M.2 スロット × 2-4                          │  │
  │ │  DIMM × 4                                    │  │
  │ │  SATA × 4-8                                  │  │
  │ │  USB ヘッダ × 多数                           │  │
  │ │                                              │  │
  │ └──────────────────────────────────────────────┘  │
  │ → 最も一般的、拡張性最高                           │
  └────────────────────────────────────────────────────┘

  ┌──────────────────────────────────────────┐
  │ Micro-ATX (244 × 244 mm)                │
  │ ┌──────────────────────────────────┐    │
  │ │  PCIe x16 × 1-2                  │    │
  │ │  M.2 × 1-2                       │    │
  │ │  DIMM × 2-4                      │    │
  │ │  SATA × 4-6                      │    │
  │ └──────────────────────────────────┘    │
  │ → コスパ重視、程よいサイズ              │
  └──────────────────────────────────────────┘

  ┌────────────────────────────────┐
  │ Mini-ITX (170 × 170 mm)       │
  │ ┌──────────────────────┐      │
  │ │  PCIe x16 × 1        │      │
  │ │  M.2 × 1-2           │      │
  │ │  DIMM × 2            │      │
  │ │  SATA × 2-4          │      │
  │ └──────────────────────┘      │
  │ → 小型PC、HTPC向け            │
  └────────────────────────────────┘

  サーバー向け:
  ┌────────────────────────────────────────────────────────┐
  │ E-ATX (305 × 330 mm)                                   │
  │ → デュアルソケット対応、DIMM × 8-16                     │
  │                                                         │
  │ EEB (305 × 330 mm)                                     │
  │ → サーバー標準、多数のPCIeスロット                       │
  │                                                         │
  │ OCP (Open Compute Project)                              │
  │ → データセンター向けオープン規格                          │
  └────────────────────────────────────────────────────────┘
```

---

## 2. バスの種類と進化

### 2.1 バスの歴史

| 規格 | 年代 | 帯域幅 | 特徴 |
|------|------|--------|------|
| ISA | 1981 | 8 MB/s | IBM PC初期のバス |
| PCI | 1992 | 133 MB/s | 共有バス、プラグ&プレイ |
| AGP | 1997 | 2.1 GB/s | GPU専用バス |
| PCI Express 1.0 | 2003 | 250 MB/s/lane | ポイントtoポイント、レーン制 |
| PCIe 2.0 | 2007 | 500 MB/s/lane | 帯域2倍 |
| PCIe 3.0 | 2010 | 985 MB/s/lane | 128b/130bエンコーディング |
| PCIe 4.0 | 2017 | 1,969 MB/s/lane | NVMe SSDの標準 |
| PCIe 5.0 | 2019 | 3,938 MB/s/lane | サーバー、ハイエンド |
| PCIe 6.0 | 2022 | 7,877 MB/s/lane | PAM4、FEC必須 |
| PCIe 7.0 | 2025 | 15,754 MB/s/lane | 策定中 |

### 2.2 PCIe の構造

```
PCIe レーン構成:

  PCIe x1:  ──→  1レーン  =  3.9 GB/s (PCIe 5.0)
  PCIe x4:  ────→ 4レーン  = 15.8 GB/s (NVMe SSD)
  PCIe x8:  ────────→ 8レーン  = 31.5 GB/s
  PCIe x16: ────────────────→ 16レーン = 63.0 GB/s (GPU)

  各レーンは独立した送受信ペア（差動信号）:
  ┌──────┐         ┌──────┐
  │ CPU  │ ──TX──→ │ GPU  │  送信
  │      │ ←──RX── │      │  受信
  └──────┘         └──────┘
  → 全二重通信（同時送受信）
```

### 2.3 PCIe の詳細技術

```
PCIeのプロトコル層:

  ┌─────────────────────────────────────┐
  │ トランザクション層 (TLP)             │
  │ - メモリ読み/書き、I/O、設定         │
  │ - パケットベースの通信               │
  │ - フロー制御（クレジットベース）      │
  ├─────────────────────────────────────┤
  │ データリンク層 (DLLP)                │
  │ - CRCによるエラー検出                │
  │ - ACK/NAKによる再送制御              │
  │ - フロー制御情報の送受信             │
  ├─────────────────────────────────────┤
  │ 物理層                               │
  │ - 差動信号ペア                       │
  │ - エンコーディング                   │
  │   PCIe 1.0-2.0: 8b/10b (20%オーバーヘッド) │
  │   PCIe 3.0-5.0: 128b/130b (1.5%オーバーヘッド) │
  │   PCIe 6.0-7.0: PAM4 + FEC          │
  │ - レーン幅: x1, x2, x4, x8, x16    │
  └─────────────────────────────────────┘

PCIe世代ごとの帯域幅計算:

  PCIe 3.0 x4 (NVMe SSD):
    転送レート: 8 GT/s × 4レーン = 32 GT/s
    エンコーディング: 128b/130b
    実効帯域幅: 32 × (128/130) / 8 = 3.938 GB/s
    → 約3.9 GB/s（片方向）

  PCIe 5.0 x16 (GPU):
    転送レート: 32 GT/s × 16レーン = 512 GT/s
    エンコーディング: 128b/130b
    実効帯域幅: 512 × (128/130) / 8 = 63.0 GB/s
    → 約63 GB/s（片方向）、双方向で126 GB/s

  PCIe 6.0 x16:
    転送レート: 64 GT/s × 16レーン = 1024 GT/s
    変調方式: PAM4（2ビット/シンボル）
    FECオーバーヘッド: 約3%
    実効帯域幅: 約121 GB/s（片方向）
```

### 2.4 PCIeレーン配分の実例

```
Intel 14th Gen (Raptor Lake) のPCIeレーン配分:

  CPU直結レーン（合計20レーン + 4 DMI）:
  ┌─────────────────────────────────────────┐
  │ CPU                                      │
  │ ├── PCIe 5.0 x16 → GPU                  │
  │ ├── PCIe 4.0 x4  → M.2 SSD (1番目)     │
  │ └── DMI 4.0 x4   → PCH                  │
  └─────────────────────────────────────────┘

  PCH (Z790) レーン（合計28レーン）:
  ┌─────────────────────────────────────────┐
  │ PCH (Z790)                               │
  │ ├── PCIe 4.0 x4 → M.2 SSD (2番目)      │
  │ ├── PCIe 3.0 x4 → M.2 SSD (3番目)      │
  │ ├── PCIe 3.0 x16 → 拡張スロット         │
  │ ├── SATA × 8                             │
  │ ├── USB 3.2 × 5                          │
  │ ├── USB 2.0 × 14                        │
  │ ├── Ethernet                             │
  │ └── Audio, Wi-Fi 等                      │
  └─────────────────────────────────────────┘

  注意: PCHのレーンは共有リソース
  → M.2 SSDを使うとSATAポートが無効化されることがある
  → マザーボードのマニュアルで帯域共有を確認する必要あり

AMD Ryzen 7000 (AM5) のPCIeレーン配分:

  CPU直結レーン（合計28レーン + 4 GMI）:
  ┌─────────────────────────────────────────┐
  │ CPU                                      │
  │ ├── PCIe 5.0 x16 → GPU                  │
  │ ├── PCIe 5.0 x4  → M.2 SSD (1番目)     │
  │ ├── PCIe 4.0 x4  → M.2 SSD (2番目)     │
  │ ├── USB4 × 2                             │
  │ └── GMI → チップセット                   │
  └─────────────────────────────────────────┘
  → AMD はCPU直結レーンが多く、GPU分岐（x8+x8）も可能
```

### 2.5 PCIeの電力供給

```
PCIeスロットの電力供給能力:

  │ スロット │ PCIe 3.0 │ PCIe 4.0 │ PCIe 5.0 │ PCIe 6.0 │
  │──────────│──────────│──────────│──────────│──────────│
  │ x1       │ 10W      │ 10W      │ 10W      │ 10W      │
  │ x4       │ 25W      │ 25W      │ 25W      │ 25W      │
  │ x8       │ 25W      │ 25W      │ 25W      │ 25W      │
  │ x16      │ 75W      │ 75W      │ 75W      │ 75W      │

  GPU の追加電力供給:
  ┌─────────────────────────────────────────────┐
  │ コネクタ          │ 電力    │ 使用例         │
  │───────────────────│─────────│────────────────│
  │ PCIeスロットのみ   │ 75W    │ ローエンドGPU  │
  │ + 6ピン ×1        │ 150W   │ ミドルレンジ    │
  │ + 8ピン ×1        │ 225W   │ ハイエンド      │
  │ + 8ピン ×2        │ 375W   │ RTX 3090等     │
  │ 12VHPWR (600W)    │ 675W   │ RTX 4090       │
  │ 12V-2×6 (600W)    │ 675W   │ RTX 50系列     │
  └─────────────────────────────────────────────┘

  12VHPWR コネクタ（PCIe 5.0電源コネクタ）:
  - 16ピン（12ピン電力 + 4ピンセンス）
  - 最大600W供給可能
  - ケーブル接続不良による溶融問題が報告あり（Gen5時代の課題）
```

---

## 3. USB規格

### 3.1 USB規格比較

| 規格 | 年 | 速度 | 電力供給 | コネクタ |
|------|-----|------|---------|---------|
| USB 1.1 | 1998 | 12 Mbps | 2.5W | Type-A/B |
| USB 2.0 | 2000 | 480 Mbps | 2.5W | Type-A/B |
| USB 3.0 | 2008 | 5 Gbps | 4.5W | Type-A(青)/B |
| USB 3.1 Gen2 | 2013 | 10 Gbps | 100W (PD) | Type-C |
| USB 3.2 Gen2x2 | 2017 | 20 Gbps | 100W (PD) | Type-C |
| USB4 v1 | 2019 | 40 Gbps | 100W (PD) | Type-C |
| USB4 v2 | 2022 | 80 Gbps | 240W (EPR) | Type-C |
| Thunderbolt 5 | 2024 | 120 Gbps | 240W | Type-C |

### 3.2 USB Type-C の統一

```
USB Type-Cコネクタ（24ピン）:

  ┌─────────────────────────────────┐
  │ ● ● ● ● ● ● ● ● ● ● ● ● │ 上段12ピン
  │ ● ● ● ● ● ● ● ● ● ● ● ● │ 下段12ピン
  └─────────────────────────────────┘

  リバーシブル: どちら向きでも挿せる
  統合: USB、Thunderbolt、DisplayPort、電力供給を1本で

  ただし注意: Type-Cコネクタ ≠ USB4
  → 見た目は同じType-Cでも、USB 2.0の速度しか出ないケーブルもある
  → ケーブル/デバイスの仕様確認が重要
```

### 3.3 USB Power Delivery (PD) の詳細

```
USB PD の電圧・電流の組み合わせ:

  USB PD 3.1 (SPR: Standard Power Range):
  │ 電圧    │ 最大電流 │ 最大電力 │ 用途              │
  │─────────│──────────│──────────│───────────────────│
  │ 5V      │ 3A       │ 15W      │ スマホ充電         │
  │ 9V      │ 3A       │ 27W      │ タブレット充電     │
  │ 15V     │ 3A       │ 45W      │ 薄型ノートPC       │
  │ 20V     │ 3A       │ 60W      │ 標準ノートPC       │
  │ 20V     │ 5A       │ 100W     │ 高性能ノートPC     │

  USB PD 3.1 (EPR: Extended Power Range):
  │ 電圧    │ 最大電流 │ 最大電力 │ 用途              │
  │─────────│──────────│──────────│───────────────────│
  │ 28V     │ 5A       │ 140W     │ ゲーミングノート   │
  │ 36V     │ 5A       │ 180W     │ モバイルワークステーション│
  │ 48V     │ 5A       │ 240W     │ 高性能デバイス     │

  PD ネゴシエーション:
  ┌──────────┐                    ┌──────────┐
  │ 充電器   │ ── CC Line ──→   │ デバイス  │
  │ (Source) │ ← USB PD Message │ (Sink)   │
  └──────────┘                    └──────────┘

  1. デバイスが充電器に接続
  2. CCライン（Configuration Channel）で通信開始
  3. 充電器が対応電圧・電流を通知（Source Capabilities）
  4. デバイスが希望する電圧・電流を要求（Request）
  5. 充電器が承認 → 電圧切り替え
  → 全て自動、ユーザー操作不要
```

### 3.4 USB の内部プロトコル

```
USB のデータ転送タイプ:

  ■ コントロール転送
    - デバイス設定、ステータス取得
    - 双方向、小サイズ
    - 全USBデバイスが使用

  ■ バルク転送
    - 大量データ転送（ストレージ、プリンタ）
    - 帯域保証なし、エラー訂正あり
    - 空き帯域を最大限活用

  ■ アイソクロナス転送
    - リアルタイムデータ（音声、動画）
    - 帯域保証あり、エラー訂正なし
    - 遅延より連続性を重視

  ■ インタラプト転送
    - 少量の定期データ（キーボード、マウス）
    - ポーリング間隔保証
    - 低レイテンシ

USB 3.0以降の物理層:
  ┌─────────────────────────────────────────┐
  │ USB 2.0 ペア (D+/D-): 480 Mbps          │ ← 後方互換
  │ USB 3.0 TX ペア:       5 Gbps            │ ← 追加
  │ USB 3.0 RX ペア:       5 Gbps            │ ← 追加
  └─────────────────────────────────────────┘
  → USB 3.0以降はUSB 2.0信号線も同時搭載（互換性維持）
  → Type-Cケーブルでは更にCC、SBU、VBUS等のピンが追加
```

---

## 4. ブートプロセス

### 4.1 電源投入からOS起動まで

```
ブートプロセスの全段階:

  ┌──────────────┐
  │ 1. 電源投入   │ ← 電源ユニットがPower Good信号を送出
  └──────┬───────┘
         ▼
  ┌──────────────┐
  │ 2. リセット   │ ← CPUのリセットベクタ（0xFFFFFFF0）にジャンプ
  └──────┬───────┘
         ▼
  ┌──────────────┐
  │ 3. BIOS/UEFI │ ← SPIフラッシュからファームウェアをロード
  │    初期化    │    CPUキャッシュをRAMとして一時使用（CAR）
  └──────┬───────┘
         ▼
  ┌──────────────┐
  │ 4. POST      │ ← Power-On Self Test
  │    (自己診断)│    メモリ検出、デバイス初期化、エラーチェック
  └──────┬───────┘    ビープ音でエラー通知（メモリなし=連続ビープ等）
         ▼
  ┌──────────────┐
  │ 5. ブート     │ ← ブートデバイスを検索（NVMe→USB→Network）
  │    デバイス   │    UEFI: ESP (EFI System Partition) を探す
  │    選択      │    BIOS: MBRの先頭512バイトを読む
  └──────┬───────┘
         ▼
  ┌──────────────┐
  │ 6. ブート     │ ← GRUB, systemd-boot, Windows Boot Manager等
  │    ローダー  │    カーネルイメージとinitramfsをメモリにロード
  └──────┬───────┘
         ▼
  ┌──────────────┐
  │ 7. カーネル   │ ← ハードウェア初期化、ドライバーロード
  │    初期化    │    ルートファイルシステムのマウント
  └──────┬───────┘
         ▼
  ┌──────────────┐
  │ 8. init/     │ ← systemd (PID 1) がサービスを起動
  │    systemd   │    ネットワーク、ログ、GUI等
  └──────┬───────┘
         ▼
  ┌──────────────┐
  │ 9. ログイン   │ ← ユーザーの操作可能状態
  └──────────────┘

  所要時間: 数秒（NVMe + UEFI + SSD）〜数分（HDD + BIOS）
```

### 4.2 BIOS vs UEFI

| 項目 | BIOS (Legacy) | UEFI |
|------|-------------|------|
| 策定 | 1975年 (IBM PC) | 2007年 (Intel主導) |
| インターフェース | テキストベース | GUIサポート |
| ブートドライバ | 16ビット | 64ビット |
| パーティション | MBR (最大2TB) | GPT (最大8ZB) |
| セキュリティ | なし | Secure Boot |
| 起動速度 | 遅い | 高速 |
| ネットワーク | なし | PXEブート標準 |

### 4.3 UEFI の詳細

```
UEFI ブートの詳細フロー:

  1. SEC (Security Phase)
     - CPUの初期化（マイクロコード適用）
     - 一時RAM（CAR: Cache As RAM）の設定
     - セキュリティ検証の開始

  2. PEI (Pre-EFI Initialization)
     - メモリコントローラの初期化
     - DRAM トレーニング（タイミング最適化）
     - 実RAMが使用可能に

  3. DXE (Driver Execution Environment)
     - デバイスドライバのロード
     - プロトコルの初期化
     - PCI/PCIeデバイスの列挙

  4. BDS (Boot Device Selection)
     - ブートオプションの列挙
     - ESP（EFI System Partition）の探索
     - ユーザー選択またはデフォルトでブート

  5. TSL (Transient System Load)
     - ブートローダーの実行
     - OS カーネルのロード

  6. RT (Runtime)
     - OS実行中もUEFIランタイムサービスが利用可能
     - 時計、変数ストア、電源管理等

ESP（EFI System Partition）の構造:
  /boot/efi/ (FAT32, 通常 100-500MB)
  ├── EFI/
  │   ├── BOOT/
  │   │   └── BOOTX64.EFI    ← デフォルトブートエントリ
  │   ├── ubuntu/
  │   │   └── grubx64.efi    ← Ubuntu のGRUB
  │   ├── Microsoft/
  │   │   └── Boot/
  │   │       └── bootmgfw.efi ← Windows Boot Manager
  │   └── fedora/
  │       └── shimx64.efi    ← Fedora（Secure Boot対応）
  └── ...

Secure Boot:
  ┌──────────────────────────────────────────────┐
  │ 信頼チェーン:                                  │
  │                                                │
  │ Platform Key (PK)                              │
  │   └── Key Exchange Key (KEK)                   │
  │       └── db (許可された署名のデータベース)     │
  │           └── ブートローダーの署名を検証        │
  │               └── カーネルの署名を検証          │
  │                                                │
  │ → 未署名のコードはブート時に実行不可            │
  │ → マルウェアの早期検出                         │
  └──────────────────────────────────────────────┘
```

```bash
# UEFI関連の確認コマンド（Linux）

# ブートエントリの一覧
efibootmgr -v

# ブート順序の変更
sudo efibootmgr -o 0001,0002,0003

# 新しいブートエントリの追加
sudo efibootmgr -c -d /dev/nvme0n1 -p 1 \
    -l /EFI/ubuntu/grubx64.efi -L "Ubuntu"

# Secure Bootの状態確認
mokutil --sb-state

# UEFI変数の表示
ls /sys/firmware/efi/efivars/

# systemdのブート時間分析
systemd-analyze
systemd-analyze blame | head -20
systemd-analyze plot > boot.svg

# dmesg でブートログ確認
dmesg | head -100
```

---

## 5. チップセットアーキテクチャ

### 5.1 進化の歴史

```
旧式（2000年代）:
  ┌─────┐   FSB    ┌───────────┐   ┌──────┐
  │ CPU │←────────→│ノースブリッジ│──→│ GPU  │
  └─────┘          │(MCH)       │   └──────┘
                   └──────┬────┘
                          │
                   ┌──────┴────┐
                   │サウスブリッジ│──→ USB, SATA, Audio
                   │(ICH)       │
                   └───────────┘

現代（2020年代）:
  ┌──────────────────────┐
  │        CPU            │
  │  ┌──────────────────┐│
  │  │ メモリコントローラ ││──→ DDR5 RAM
  │  │ PCIe コントローラ  ││──→ GPU (PCIe x16)
  │  │                    ││──→ NVMe (PCIe x4)
  │  └──────────────────┘│
  └──────────┬───────────┘
             │ DMI 4.0 (〜8GB/s)
             ▼
  ┌──────────────────────┐
  │   PCH (Platform      │
  │   Controller Hub)    │──→ USB, SATA, Audio
  │                      │──→ Wi-Fi, Ethernet
  │                      │──→ 追加PCIeレーン
  └──────────────────────┘

  進化: ノースブリッジ機能がCPUに統合
  → メモリアクセスの高速化（バスのボトルネック除去）
  → GPU接続の低レイテンシ化
```

### 5.2 Intel vs AMD チップセット比較

```
Intel Z790 vs AMD X670E チップセット比較:

  │ 機能              │ Z790         │ X670E         │
  │───────────────────│──────────────│───────────────│
  │ CPU-PCH接続       │ DMI 4.0 x4   │ GMI（独自）   │
  │ CPU直結PCIe 5.0   │ x16 + x4     │ x16 + x4 + x4│
  │ CPU直結PCIe 4.0   │ x4           │ なし          │
  │ PCH PCIe 4.0      │ x12          │ x12           │
  │ PCH PCIe 3.0      │ x16          │ x8            │
  │ USB 3.2 Gen2x2    │ 5            │ 6             │
  │ USB4               │ なし         │ 2（CPU直結）  │
  │ SATA               │ 8            │ 8             │
  │ DDRサポート        │ DDR4/DDR5    │ DDR5のみ      │
  │ OC対応             │ 対応         │ 対応          │

  AMD X670E はチップセット自体が2チップ構成:
  ┌──────────┐     ┌──────────┐
  │ Promontory│────│ Promontory│
  │ チップ1   │    │ チップ2   │
  └──────────┘     └──────────┘
  → より多くのI/Oを提供するが、消費電力増
```

### 5.3 DMI（Direct Media Interface）のボトルネック

```
DMIボトルネックの理解:

  CPU直結のPCIe: 高帯域・低レイテンシ
  PCH経由のデバイス: DMIが帯域の上限

  DMI 4.0 x4 の帯域幅:
  = PCIe 4.0 x4 = 約 8 GB/s

  PCH配下のデバイスが全て同時にアクセスすると:
  NVMe SSD (PCH経由): 最大3.5 GB/s
  + USB 3.2 Gen2 ×2: 2.5 GB/s
  + 2.5G Ethernet: 0.3 GB/s
  + SATA SSD ×2: 1.0 GB/s
  合計: 7.3 GB/s → DMI帯域に収まるが余裕は少ない

  対策:
  - 高帯域が必要なデバイス（GPU、プライマリNVMe）はCPU直結を選ぶ
  - PCH経由のNVMe SSDは2番目以降のストレージに
  - ネットワークカードをPCIeスロットに増設する場合も注意
```

---

## 6. メモリバスとDDR

### 6.1 DDR世代の比較

```
DDRメモリの世代比較:

  │ 規格     │ 年    │ 転送レート  │ 帯域幅(1ch) │ 電圧  │
  │──────────│───────│─────────────│─────────────│───────│
  │ DDR3     │ 2007  │ 800-2133    │ 17 GB/s     │ 1.5V  │
  │ DDR4     │ 2014  │ 2133-5333   │ 42.7 GB/s   │ 1.2V  │
  │ DDR5     │ 2020  │ 4800-8800   │ 70.4 GB/s   │ 1.1V  │
  │ DDR5 OC  │ 2024  │ 9200+       │ 73.6 GB/s   │ 1.35V │

  DDR5 の主な改良点:
  ┌───────────────────────────────────────────────┐
  │ DDR4:                                          │
  │ ┌──────────────────────────────────────────┐  │
  │ │ 1チャネル × 64ビット幅                    │  │
  │ │ バースト長: 8                              │  │
  │ │ バンクグループ: 4                          │  │
  │ │ PMIC: マザーボード上                       │  │
  │ └──────────────────────────────────────────┘  │
  │                                                │
  │ DDR5:                                          │
  │ ┌──────────────────────────────────────────┐  │
  │ │ 2サブチャネル × 32ビット幅               │  │
  │ │ バースト長: 16                             │  │
  │ │ バンクグループ: 8                          │  │
  │ │ PMIC: DIMM上（電圧調整がモジュール側に）  │  │
  │ │ On-die ECC: 内蔵エラー訂正                │  │
  │ └──────────────────────────────────────────┘  │
  │                                                │
  │ → 2サブチャネルで帯域効率向上                   │
  │ → PMICがモジュール上でクリーンな電力供給         │
  └───────────────────────────────────────────────┘

デュアルチャネル vs シングルチャネル:
  シングルチャネル: 1本のDIMM = 帯域幅 × 1
  デュアルチャネル: 2本のDIMM = 帯域幅 × 2
  クアッドチャネル: 4本のDIMM = 帯域幅 × 4（サーバー/HEDT）
  オクタチャネル:   8本のDIMM = 帯域幅 × 8（サーバー）

  → iGPUを使う場合、デュアルチャネルでフレームレートが2倍近くになる場合も
  → 常にデュアルチャネル構成（2枚または4枚）で組むべき
```

---

## 7. 最新トレンド

### 7.1 CXL（Compute Express Link）

```
CXL の3つのプロトコル:

  CXL.io   — PCIeベースのデバイスI/O（レガシー互換）
  CXL.cache — デバイスがホストメモリをキャッシュ
  CXL.mem   — ホストがデバイスメモリにアクセス

  応用例:
  ┌──────┐        CXL        ┌──────────────────┐
  │ CPU  │←──────────────────→│ CXL メモリ拡張    │
  └──────┘                    │ (DRAM増設、       │
                              │  不揮発メモリ)    │
                              └──────────────────┘
  → RAMをサーバー間で共有（メモリプーリング）
  → 従来不可能だったTB級メモリ空間を実現

CXL のバージョン:
  │ バージョン │ 年   │ 帯域幅     │ 主な機能                │
  │────────────│──────│────────────│─────────────────────────│
  │ CXL 1.1    │ 2020 │ PCIe 5.0   │ メモリ拡張の基本        │
  │ CXL 2.0    │ 2022 │ PCIe 5.0   │ メモリプーリング        │
  │ CXL 3.0    │ 2023 │ PCIe 6.0   │ マルチレベルスイッチング│
  │ CXL 3.1    │ 2024 │ PCIe 6.0   │ TSP（セキュリティ強化） │

CXLのデータセンター活用:
  従来: 各サーバーに固定量のDRAM
  ┌──────┐ ┌──────┐ ┌──────┐
  │128GB │ │256GB │ │64GB  │  ← メモリの無駄が発生
  │(50%  │ │(30%  │ │(90%  │
  │使用) │ │使用) │ │使用) │
  └──────┘ └──────┘ └──────┘

  CXL: メモリプール共有
  ┌──────┐ ┌──────┐ ┌──────┐
  │CPU 1 │ │CPU 2 │ │CPU 3 │
  └──┬───┘ └──┬───┘ └──┬───┘
     │        │        │
  ┌──┴────────┴────────┴──┐
  │   CXL メモリプール     │
  │   合計: 448GB          │
  │   各CPUが必要な分だけ使用│
  └────────────────────────┘
  → メモリ利用率の大幅向上（TCO削減）
```

### 7.2 チップレットアーキテクチャ

| アプローチ | 説明 | 例 |
|-----------|------|-----|
| モノリシック | 1枚の大きなダイ | Intel Core (旧世代) |
| チップレット | 複数の小ダイを接続 | AMD EPYC, Apple M2 Ultra |
| UCIe | チップレット間の標準規格 | Intel, AMD, ARM共同策定 |

> 歩留まり向上、異なるプロセスノードの混在、柔軟なスケーリング。

```
チップレット接続技術:

  ■ AMD Infinity Fabric
    ┌────────┐  IF  ┌────────┐
    │ CCD 0  │────→│ CCD 1  │   CCD = Core Complex Die
    │ 8コア  │←────│ 8コア  │
    └───┬────┘     └───┬────┘
        │              │
    ┌───┴──────────────┴───┐
    │      IOD (I/O Die)    │
    │  メモリコントローラ    │
    │  PCIeコントローラ      │
    └───────────────────────┘
    → CCD: 5nm (最先端)、IOD: 6nm (安価) で混在可能

  ■ Apple UltraFusion
    ┌────────────────┐  UF  ┌────────────────┐
    │ M2 Max Die 1   │────→│ M2 Max Die 2   │
    │                │←────│                │
    │ GPU 38コア     │      │ GPU 38コア     │
    │ CPU 12コア     │      │ CPU 12コア     │
    └────────────────┘      └────────────────┘
    帯域幅: 2.5 TB/s（シリコンインターポーザ）
    → 2つのM2 Maxを1つのM2 Ultraとして使用

  ■ UCIe (Universal Chiplet Interconnect Express)
    - 業界標準のチップレット接続規格
    - 異なるベンダーのチップレットを組み合わせ可能
    - 帯域幅: 最大256 GB/s/mm
    - Intel, AMD, ARM, Samsung, TSMC等が参画
```

---

## 8. サーバーアーキテクチャ

### 8.1 サーバーとデスクトップの違い

```
サーバーマザーボードの特徴:

  │ 機能              │ デスクトップ    │ サーバー            │
  │───────────────────│─────────────────│─────────────────────│
  │ CPUソケット       │ 1              │ 1-2（デュアルソケット）│
  │ メモリスロット    │ 2-4            │ 8-24                │
  │ メモリ種類        │ UDIMM          │ RDIMM/LRDIMM (ECC) │
  │ 最大メモリ        │ 128GB          │ 4-6TB               │
  │ PCIeスロット      │ 1-3            │ 6-10                │
  │ ネットワーク      │ 1GbE-2.5GbE   │ 10/25/100GbE        │
  │ ストレージ        │ M.2 × 2-3     │ U.2/E1.S × 24+     │
  │ リモート管理      │ なし           │ IPMI/BMC/iLO/iDRAC │
  │ 冗長電源          │ なし           │ あり（ホットスワップ）│
  │ ECC メモリ        │ 基本なし       │ 必須                │

  IPMI/BMC（Baseboard Management Controller）:
  ┌────────────────────────────────────────┐
  │ BMC チップ                              │
  │ - 独立したCPU（ARM Cortex等）          │
  │ - 独立したネットワーク接続             │
  │ - OS停止中もサーバー管理可能           │
  │ - 電源ON/OFF                           │
  │ - KVM（キーボード・ビデオ・マウス）    │
  │ - ファームウェアアップデート           │
  │ - ハードウェア監視（温度、電圧、ファン）│
  │ - シリアルコンソール                   │
  └────────────────────────────────────────┘
  → データセンターでの物理アクセスなしでサーバー管理
```

### 8.2 NUMAアーキテクチャ

```
NUMA（Non-Uniform Memory Access）:

  デュアルソケットサーバーの場合:
  ┌─────────────────────────────────────────────┐
  │ NUMA Node 0               NUMA Node 1       │
  │ ┌─────────┐               ┌─────────┐     │
  │ │ CPU 0   │               │ CPU 1   │     │
  │ │ 32コア  │──── QPI/UPI ──│ 32コア  │     │
  │ └────┬────┘               └────┬────┘     │
  │      │                         │           │
  │ ┌────┴────┐               ┌────┴────┐     │
  │ │ DDR5    │               │ DDR5    │     │
  │ │ 256GB   │               │ 256GB   │     │
  │ │ ローカル │               │ ローカル │     │
  │ └─────────┘               └─────────┘     │
  └─────────────────────────────────────────────┘

  メモリアクセスレイテンシ:
  - ローカルメモリ: 80ns
  - リモートメモリ: 130ns（約1.6倍遅い）

  → OSとアプリケーションはNUMAを意識したメモリ配置が重要
  → numactl コマンドでNUMA制御可能
```

```bash
# NUMA情報の確認
numactl --hardware

# NUMA Node 0 でプロセスを実行
numactl --cpunodebind=0 --membind=0 ./my_application

# NUMAバランスの確認
cat /proc/sys/kernel/numa_balancing

# メモリのNUMA配置状況
numastat -m
```

---

## 9. 実践演習

### 演習1: スペックの読み方（基礎）

自分のPC/Macのスペックを調べ、以下を特定せよ:
1. CPUソケット/チップの種類
2. メモリの規格（DDR4/DDR5）、チャネル数、帯域幅
3. ストレージの接続方式（NVMe/SATA）
4. USBポートの種類と速度

### 演習2: ボトルネック分析（応用）

以下のシステムで、ボトルネックになりうる箇所を特定せよ:
- CPU: AMD Ryzen 9 7950X (16コア)
- RAM: DDR5-5200 64GB（デュアルチャネル）
- GPU: NVIDIA RTX 4090 (PCIe 4.0 x16)
- Storage: Samsung 990 Pro 2TB (PCIe 4.0 x4)
- ワークロード: 4K動画編集 + AI学習

### 演習3: ブートプロセスの観察（発展）

LinuxマシンでUEFIブートプロセスを観察せよ:
```bash
# ブートログの確認
journalctl -b | head -100

# UEFIブート変数の確認
efibootmgr -v

# PCIeデバイスの列挙
lspci -vvv | head -50

# USBデバイスの列挙
lsusb -t
```

### 演習4: PCIeレーン配分の設計（応用）

以下の要件を満たすシステムのPCIeレーン配分を設計せよ:
- GPU: RTX 4090（x16必須）
- NVMe SSD: 2TB × 2台（各x4）
- 10GbE NIC: x4
- Thunderbolt 4 カード: x4
- プラットフォーム: Intel Z790

レーンの不足をどう解決するか、トレードオフを論じよ。

### 演習5: サーバー構成の設計（発展）

以下の要件のサーバーを設計せよ:
- 用途: PostgreSQL データベースサーバー
- CPU: デュアルソケット希望
- メモリ: 512GB以上（ECC必須）
- ストレージ: NVMe SSD RAID 10
- ネットワーク: 25GbE × 2（冗長）
- 予算: 300万円以内

設計項目:
1. CPU/プラットフォームの選定
2. メモリ構成（DIMM数、チャネル配分）
3. ストレージ構成（台数、RAID）
4. ネットワーク構成
5. 冗長性の確保方法

---

## FAQ

### Q1: マザーボードの選び方は？

**A**: 以下の順で決める:
1. CPUソケット（Intel LGA1700、AMD AM5等）
2. チップセット（機能差: PCIeレーン数、USB数、オーバークロック対応）
3. フォームファクタ（ATX/mATX/Mini-ITX）
4. メモリスロット数とDDR世代
5. M.2/NVMeスロット数
6. 拡張性（PCIeスロット、USB、ネットワーク）

### Q2: Thunderbolt と USB4 の違いは？

**A**: Thunderbolt 4/5 は USB4 のスーパーセット:
- USB4: 最低20Gbps保証
- Thunderbolt 4: 40Gbps保証 + DP 2.0 + PCIeトンネリング
- Thunderbolt 5: 80-120Gbps + 240W給電

全てType-Cコネクタを使用するが、性能はケーブルとデバイスの対応次第。

### Q3: なぜPCIeは「レーン」単位なのですか？

**A**: 柔軟なスケーリングのため。デバイスの帯域要求に応じてレーン数を変えられる:
- NVMe SSD: x4で十分（〜8GB/s）
- GPU: x16で最大帯域（〜32GB/s）
- Wi-Fiカード: x1で十分（〜1GB/s）
マザーボード上のPCIeレーン数はCPU+チップセットで決まり、配分はBIOSで設定可能。

### Q4: DDR5はDDR4よりどのくらい速いですか？

**A**: 帯域幅は約1.5-2倍だが、レイテンシは同等かやや悪い:
- DDR4-3200: 帯域25.6GB/s、CL16 = 10ns
- DDR5-5600: 帯域44.8GB/s、CL36 = 12.86ns
- 帯域重視のワークロード（動画編集、AI）はDDR5が有利
- レイテンシ重視のワークロード（ゲーム）はDDR4との差が小さい

### Q5: VRMの品質はどう見分けますか？

**A**: 以下のポイントを確認:
- フェーズ数: 12フェーズ以上が望ましい（OC用途なら16+）
- MOSFET: DrMOS（高効率統合型）が理想
- ヒートシンク: VRM上に大型ヒートシンクがあるか
- PWMコントローラ: Renesas/Infineonの高品質チップ
- レビューサイトのサーモグラフィーテスト結果

### Q6: Secure Bootを無効にしても大丈夫ですか？

**A**: 一般的なLinux使用なら多くのディストリビューションがSecure Boot対応済み。無効化が必要なケース:
- カスタムカーネルの使用
- 署名されていないドライバ（一部のNVIDIAドライバ等）
- デュアルブートの特殊構成
セキュリティの観点からは有効のままが推奨。企業環境では必須であることが多い。

---

## まとめ

| 概念 | ポイント |
|------|---------|
| マザーボード | CPU、メモリ、PCH（チップセット）を接続する基盤 |
| PCIe | ポイントtoポイント、レーン制、世代ごとに帯域2倍 |
| USB | Type-Cに統一傾向、USB4/Thunderboltで高速化 |
| ブート | 電源→UEFI→POST→ブートローダー→カーネル→init |
| 進化 | ノースブリッジ→CPU統合、CXL、チップレット |
| DDR5 | 2サブチャネル、帯域向上、On-die ECC |
| NUMA | デュアルソケットではメモリ配置が性能に直結 |

---

## 次に読むべきガイド

→ [[04-gpu-and-parallel.md]] — GPUと並列計算

---

## 参考文献

1. PCI-SIG. "PCI Express Base Specification." Various Revisions.
2. USB Implementers Forum. "Universal Serial Bus Specification." Various Revisions.
3. UEFI Forum. "Unified Extensible Firmware Interface Specification."
4. Intel. "Platform Controller Hub (PCH) Datasheets."
5. CXL Consortium. "Compute Express Link Specification." https://www.computeexpresslink.org/
6. JEDEC. "DDR5 SDRAM Standard (JESD79-5)." 2020.
7. AMD. "AMD EPYC 9004 Series Architecture." Whitepaper.
8. UCIe Consortium. "Universal Chiplet Interconnect Express Specification." 2022.
9. Intel. "12th Gen Intel Core Processor Datasheet." Volume 1.
10. AMD. "AMD Ryzen 7000 Series Platform Technology." 2022.
