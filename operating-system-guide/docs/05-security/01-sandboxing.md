# サンドボックスと隔離

> サンドボックスは「信頼できないコードを安全な砂場に閉じ込めて、システムへの影響を最小化する」技術。

## この章で学ぶこと

- [ ] サンドボックスの概念を理解する
- [ ] 主要な隔離技術を比較できる
- [ ] コンテナの隔離メカニズムを知る

---

## 1. サンドボックス技術

```
隔離レベルの比較:

  弱い隔離 ←────────────────────→ 強い隔離
  プロセス   chroot  namespace   コンテナ   VM
  分離       分離    + cgroup    (Docker)  (KVM)

1. chroot:
   ファイルシステムのルートを変更
   → プロセスから見えるファイルを制限
   → 脱獄（escape）が比較的容易 → 本格的セキュリティには不十分

2. Linux Namespaces:
   OSリソースをプロセスごとに分離
   ┌──────────────┬──────────────────────────┐
   │ Namespace    │ 分離対象                  │
   ├──────────────┼──────────────────────────┤
   │ PID          │ プロセスID空間            │
   │ Network      │ ネットワークスタック      │
   │ Mount        │ マウントポイント          │
   │ UTS          │ ホスト名                  │
   │ IPC          │ プロセス間通信            │
   │ User         │ UID/GID マッピング        │
   │ Cgroup       │ cgroupの可視性            │
   │ Time         │ システム時刻（Linux 5.6+）│
   └──────────────┴──────────────────────────┘

3. cgroups（Control Groups）:
   リソース使用量を制限
   → CPU使用率、メモリ上限、I/O帯域
   → プロセスがリソースを食い尽くすのを防止

4. seccomp-bpf:
   許可するシステムコールをフィルタリング
   → 攻撃面を大幅に削減

コンテナ = Namespaces + cgroups + seccomp + capabilities
→ カーネルは共有（VMと異なる）
→ 軽量だがVMほどの隔離強度はない
```

---

## 2. 仮想マシン vs コンテナ

```
┌──────────────────────────────────────────┐
│ 仮想マシン                                │
│ ┌──────┐ ┌──────┐ ┌──────┐              │
│ │App A │ │App B │ │App C │              │
│ │Guest │ │Guest │ │Guest │              │
│ │ OS   │ │ OS   │ │ OS   │              │
│ └──┬───┘ └──┬───┘ └──┬───┘              │
│ ┌──┴────────┴────────┴───┐              │
│ │ Hypervisor (KVM/Xen)    │              │
│ └──────────────────────────┘              │
│ ┌──────────────────────────┐              │
│ │ Host OS + Hardware       │              │
│ └──────────────────────────┘              │
│ → 完全な隔離、異なるOS可能                │
│ → オーバーヘッド大、起動に秒〜分          │
└──────────────────────────────────────────┘

┌──────────────────────────────────────────┐
│ コンテナ                                  │
│ ┌──────┐ ┌──────┐ ┌──────┐              │
│ │App A │ │App B │ │App C │              │
│ │Libs  │ │Libs  │ │Libs  │              │
│ └──┬───┘ └──┬───┘ └──┬───┘              │
│ ┌──┴────────┴────────┴───┐              │
│ │ Container Runtime       │              │
│ │ (Docker/containerd)     │              │
│ └──────────────────────────┘              │
│ ┌──────────────────────────┐              │
│ │ Host OS (共有カーネル)    │              │
│ └──────────────────────────┘              │
│ → カーネル共有、軽量                      │
│ → 起動がミリ秒、メモリ効率良              │
└──────────────────────────────────────────┘

比較:
┌──────────┬──────────────┬──────────────┐
│ 項目     │ VM           │ コンテナ     │
├──────────┼──────────────┼──────────────┤
│ 隔離     │ 強い         │ 中程度       │
│ 起動     │ 秒〜分       │ ミリ秒       │
│ サイズ   │ GB           │ MB           │
│ OS       │ 異なるOS可   │ ホストOS共有 │
│ 用途     │ マルチテナント│ マイクロサービス│
└──────────┴──────────────┴──────────────┘

gVisor / Firecracker:
  VMとコンテナの中間
  gVisor: ユーザー空間カーネル（Google）
  Firecracker: マイクロVM（AWS Lambda/Fargate）
  → コンテナの軽さ + VMの隔離
```

---

## 3. アプリケーションサンドボックス

```
ブラウザのサンドボックス（Chrome）:
  各タブ/拡張機能を独立プロセスで実行
  → seccomp-bpf でシステムコール制限
  → Namespaceでファイルシステム分離
  → 1タブの脆弱性が他に波及しない

モバイルOS:
  iOS: 各アプリがサンドボックス内で動作
  → アプリ間のファイルアクセス不可
  → API経由でのみ他アプリと連携

  Android: SELinuxベースの強制アクセス制御
  → アプリごとにLinuxユーザーID割当
  → パーミッションモデルでAPI制限

macOS:
  App Sandbox (App Store必須)
  → エンタイトルメントで権限管理
  → ファイル、ネットワーク、カメラ等のアクセス制限
```

---

## 実践演習

### 演習1: [基礎] — Namespace の確認

```bash
# 現在のNamespace確認
ls -la /proc/self/ns/

# 新しいNamespaceでコマンド実行（要root）
sudo unshare --pid --fork --mount-proc bash
ps aux  # PID 1 から始まる別世界
```

### 演習2: [応用] — cgroup でリソース制限

```bash
# cgroup v2 でメモリ制限（Linux）
sudo mkdir /sys/fs/cgroup/test
echo 50M | sudo tee /sys/fs/cgroup/test/memory.max
echo $$ | sudo tee /sys/fs/cgroup/test/cgroup.procs
# → このシェルのメモリが50MBに制限される
```

---

## まとめ

| 技術 | 隔離レベル | 用途 |
|------|----------|------|
| chroot | 弱 | 簡易的なFS隔離 |
| Namespace | 中 | コンテナの基盤 |
| cgroup | リソース制限 | コンテナ、マルチテナント |
| VM | 強 | マルチテナント、異なるOS |
| gVisor/Firecracker | 中〜強 | サーバーレス |

---

## 次に読むべきガイド
→ [[../06-virtualization/00-vm-basics.md]] — 仮想マシンの基礎

---

## 参考文献
1. Lieberman, H. "Container Security." O'Reilly, 2020.
2. Provos, N. "Preventing Privilege Escalation." USENIX Security, 2003.
