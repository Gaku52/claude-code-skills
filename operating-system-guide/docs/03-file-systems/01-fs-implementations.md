# 主要ファイルシステム実装

> ファイルシステムの選択はワークロードに依存する。万能なFSは存在しない。

## この章で学ぶこと

- [ ] 主要なファイルシステムの特徴を比較できる
- [ ] ワークロードに応じたFS選択ができる

---

## 1. ext4（Linux標準）

```
ext4 (Fourth Extended Filesystem, 2008):
  ext2 → ext3(ジャーナリング追加) → ext4(大容量対応)

  主な特徴:
  - 最大ボリューム: 1EB (エクサバイト)
  - 最大ファイル: 16TB
  - エクステント: 連続ブロックを1エントリで管理（断片化削減）
  - 遅延割り当て: 書き込みを遅延させて最適な配置を決定
  - ジャーナリング: メタデータ+データの整合性保証
  - ディレクトリインデックス: HTree（B木ベース）で高速検索

  利点: 安定性、互換性、ツールの充実
  欠点: スナップショット非対応、チェックサム非対応
  用途: デスクトップ、一般サーバー（Ubuntu デフォルト）
```

---

## 2. XFS / Btrfs / ZFS

```
XFS (SGI, 1993 → Linux):
  - 大ファイル、高並列I/Oに最適化
  - B+木ベースのメタデータ管理
  - 最大ボリューム/ファイル: 8EB
  - オンラインリサイズ（拡張のみ、縮小不可）
  - 用途: データベース、メディアサーバー（RHEL デフォルト）

Btrfs (Oracle → Linux, 2009):
  - Copy-on-Write (CoW) ファイルシステム
  - スナップショット: 瞬時のバックアップ
  - 透過的圧縮: zstd, lzo, zlib
  - RAID: FS内蔵（ソフトウェアRAID不要）
  - チェックサム: データ破損を検出
  - サブボリューム: 柔軟なパーティショニング
  - 用途: NAS、バックアップ（SUSE デフォルト）

ZFS (Sun Microsystems, 2005):
  - 最強のデータ保護（エンタープライズ向け）
  - 128bitアドレッシング（事実上無限）
  - 全データにチェックサム
  - ネイティブRAID-Z（RAID5/6相当）
  - デデュプリケーション（重複排除）
  - ARC（Adaptive Replacement Cache）
  - 問題: Linuxではライセンス問題（CDDL vs GPL）
  - 用途: NAS(TrueNAS), データベース, バックアップ

比較:
┌──────┬──────────┬──────────┬──────────┬──────────┐
│ 項目 │ ext4     │ XFS      │ Btrfs    │ ZFS      │
├──────┼──────────┼──────────┼──────────┼──────────┤
│ CoW  │ ✗       │ ✗       │ ✓       │ ✓       │
│ 圧縮 │ ✗       │ ✗       │ ✓       │ ✓       │
│ snap │ ✗       │ ✗       │ ✓       │ ✓       │
│ RAID │ ✗       │ ✗       │ ✓       │ ✓       │
│ 安定性│ ◎      │ ◎       │ ○       │ ◎       │
│ 速度 │ ○       │ ◎       │ ○       │ ○       │
└──────┴──────────┴──────────┴──────────┴──────────┘
```

---

## 3. その他のFS

```
NTFS (Windows):
  - ジャーナリング、ACL、暗号化(EFS)、圧縮
  - LinuxからはNTFS-3gで読み書き可能

APFS (Apple, 2017):
  - CoW、スナップショット、暗号化
  - SSD最適化、ナノ秒タイムスタンプ
  - macOS, iOS, watchOS, tvOS で使用

FAT32 / exFAT:
  - 最も互換性が高い（全OS対応）
  - FAT32: 最大ファイル4GB制限
  - exFAT: 大ファイル対応、USBメモリ・SDカード向け

tmpfs:
  - RAM上のファイルシステム（/tmp, /dev/shm）
  - 超高速だが再起動で消失
  - ビルドキャッシュ、一時ファイルに最適

procfs / sysfs:
  - 仮想ファイルシステム（ディスクに実体なし）
  - カーネル情報をファイルとして公開
  - /proc/cpuinfo, /sys/class/net 等
```

---

## 実践演習

### 演習1: [基礎] — ファイルシステム情報の確認

```bash
# 現在のファイルシステムを確認
df -Th
lsblk -f
cat /etc/fstab
```

### 演習2: [応用] — FS選択判断

```
以下の用途に最適なFSを選択し理由を述べよ:
1. 100TBのNASストレージ（定期バックアップ必須）
2. 高頻度のDBトランザクション
3. USBメモリ（Windows/Mac/Linuxで共用）
4. CI/CDの一時ビルドディレクトリ
```

---

## まとめ

| FS | 特徴 | 用途 |
|----|------|------|
| ext4 | 安定、汎用 | デスクトップ、一般サーバー |
| XFS | 大ファイル、高並列 | DB、メディア |
| Btrfs | CoW、スナップショット、圧縮 | NAS、バックアップ |
| ZFS | 最強データ保護 | エンタープライズNAS |

---

## 次に読むべきガイド
→ [[02-io-scheduling.md]] — I/Oスケジューリング

---

## 参考文献
1. Carrier, B. "File System Forensic Analysis." Addison-Wesley, 2005.
2. McDougall, R. & Mauro, J. "Solaris Internals." 2nd Ed, Prentice Hall, 2006.
