# 割り込みとDMA

> 割り込みはCPUと外部デバイスの非同期通信の要。DMAはCPUを介さずに高速データ転送を実現する。

## この章で学ぶこと

- [ ] 割り込みの種類と処理フローを理解する
- [ ] DMAの仕組みを説明できる
- [ ] 現代のI/O技術を知る

---

## 1. 割り込みの詳細

```
割り込みの種類:

  1. ハードウェア割り込み（外部割り込み）:
     → デバイスからCPUへの通知
     → キーボード入力、ディスクI/O完了、タイマー、NIC受信
     → マスカブル（無視可能）/ ノンマスカブル（NMI, 無視不可）

  2. ソフトウェア割り込み（トラップ）:
     → プログラムが意図的に発生
     → システムコール（int 0x80, syscall命令）
     → デバッグブレークポイント

  3. 例外:
     → CPU内部で発生するエラー
     → ゼロ除算、ページフォルト、セグメンテーション違反
     → フォルト（再実行可能）/ トラップ / アボート

割り込み処理フロー:
  1. デバイスが割り込み信号を送出
  2. CPUが現在の命令を完了
  3. CPUの状態（レジスタ等）をスタックに保存
  4. 割り込みベクタテーブル(IDT)から
     ハンドラのアドレスを取得
  5. 割り込みハンドラを実行
  6. CPUの状態を復元
  7. 中断した命令から再開

  トップハーフ / ボトムハーフ（Linux）:
  トップハーフ: 割り込みハンドラ本体（最小限の処理、高速）
  ボトムハーフ: 遅延処理（softirq, tasklet, workqueue）
  → ハンドラ中は割り込み禁止なので、長時間処理はボトムハーフで
```

---

## 2. DMAの詳細

```
DMA転送の流れ:

  CPU                DMA Controller       Device
   │                     │                  │
   │── Setup ──────────→│                  │
   │  (src, dst, size)   │                  │
   │                     │── Data Transfer ─→│
   │ (他の仕事をする)    │←── Data ─────────│
   │                     │── Write Memory ──→│(メモリ)
   │                     │                  │
   │←── 割り込み ────────│                  │
   │  「転送完了」        │                  │

  スキャッタ/ギャザーDMA:
  不連続なメモリ領域を1回のDMAで転送
  → ネットワークパケット（ヘッダ+ペイロード）に最適

  IOMMU:
  DMAのアドレスを仮想化
  → デバイスが不正なメモリにアクセスすることを防止
  → 仮想マシンでのDMAパススルーに必須
```

---

## 3. 現代のI/O技術

```
1. MSI/MSI-X（Message Signaled Interrupts）:
   PCIeデバイスがメモリ書き込みで割り込み通知
   → 専用の割り込みピン不要
   → デバイスごとに独立した割り込みベクタ
   → マルチキュー対応（NVMe, 10GbE NIC）

2. RDMA（Remote Direct Memory Access）:
   ネットワーク越しに直接メモリアクセス
   → CPUとOSをバイパス
   → 超低レイテンシ（<1μs）
   → InfiniBand, RoCEv2
   → HPC、データセンター内通信

3. NVMe（Non-Volatile Memory Express）:
   SSD専用の高速I/Oプロトコル
   → AHCI(SATA)の65536倍のキュー深度
   → 64Kキュー × 64Kエントリ
   → CPU効率的な割り込み処理
```

---

## まとめ

| 概念 | ポイント |
|------|---------|
| 割り込み | デバイス→CPUの非同期通知。トップ/ボトムハーフ |
| DMA | CPU介さずメモリ転送。IOMMU で保護 |
| NVMe | SSD専用高速プロトコル。64Kキュー |
| RDMA | ネットワーク越し直接メモリアクセス |

---

## 次に読むべきガイド
→ [[../05-security/00-access-control.md]] — アクセス制御

---

## 参考文献
1. Corbet, J. et al. "Linux Device Drivers." 3rd Ed, O'Reilly, 2005.
2. Love, R. "Linux Kernel Development." 3rd Ed, Ch.7, 2010.
