# UDP（User Datagram Protocol）

> UDPは「速さ優先」のシンプルなプロトコル。接続確立なし、再送なし、順序保証なし。リアルタイム通信、DNS、ゲーム、そしてHTTP/3の基盤QUICを支える。

## この章で学ぶこと

- [ ] UDPの特性とTCPとの違いを理解する
- [ ] UDPが適しているユースケースを把握する
- [ ] QUICプロトコルの概要を学ぶ

---

## 1. UDPの基本特性

```
UDP = コネクションレスの軽量プロトコル

特性:
  ✓ 低レイテンシ（接続確立不要）
  ✓ 軽量ヘッダー（8バイト固定）
  ✓ ブロードキャスト/マルチキャスト対応
  ✓ アプリケーションが制御を持てる

  ✗ 信頼性なし（データ到達の保証なし）
  ✗ 順序保証なし
  ✗ フロー制御なし
  ✗ 輻輳制御なし

TCP vs UDP:
  ┌──────────────┬───────────┬───────────┐
  │              │ TCP       │ UDP       │
  ├──────────────┼───────────┼───────────┤
  │ 接続         │ あり      │ なし      │
  │ 信頼性       │ あり      │ なし      │
  │ 順序保証     │ あり      │ なし      │
  │ ヘッダー     │ 20-60B    │ 8B        │
  │ 速度         │ 遅い      │ 速い      │
  │ 輻輳制御     │ あり      │ なし      │
  │ 通信形態     │ 1対1      │ 1対1/1対多│
  └──────────────┴───────────┴───────────┘
```

---

## 2. UDPヘッダー

```
UDPヘッダー構造（8バイト固定）:

  0                   1                   2                   3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
  ┌─────────────────────────┬─────────────────────────┐
  │     送信元ポート (16)    │     宛先ポート (16)      │
  ├─────────────────────────┬─────────────────────────┤
  │     データ長 (16)        │     チェックサム (16)    │
  └─────────────────────────┴─────────────────────────┘

  TCPヘッダー（20-60バイト）と比較して極めてシンプル
  → オーバーヘッドが少ない = 高速

  最大データグラムサイズ:
  理論上: 65,507バイト（65,535 - IPヘッダー20 - UDPヘッダー8）
  実用上: 1,472バイト（MTU 1500 - IPヘッダー20 - UDPヘッダー8）
  → MTUを超えるとIPフラグメンテーションが発生
```

---

## 3. UDPのユースケース

```
① DNS（ポート53）:
  → 問い合わせ/応答が小さい（通常512バイト以内）
  → 接続確立のオーバーヘッドが不要
  → 応答がなければ再度問い合わせるだけ
  ※ 大きな応答にはTCPフォールバック

② 動画/音声ストリーミング:
  → リアルタイム性が重要
  → 1パケット欠落しても全体への影響は小さい
  → 再送よりも次のフレームを優先
  RTP（Real-time Transport Protocol）がUDP上で動作

③ オンラインゲーム:
  → 低レイテンシが最優先
  → 古い位置情報の再送は無意味
  → ゲーム側で必要な信頼性を実装

④ IoTセンサーデータ:
  → 小さなデータを高頻度で送信
  → 個々のデータの欠損は許容可能
  → 接続維持のオーバーヘッドを削減

⑤ VPN:
  → WireGuard はUDPベース
  → TCPオーバーTCPの問題を回避

⑥ DHCP:
  → IPアドレス未設定の段階で通信が必要
  → ブロードキャスト通信を使用
```

---

## 4. UDP上のアプリケーション層での信頼性

```
UDPを使いつつ、必要な信頼性はアプリ層で実装:

パターン1: シーケンス番号 + ACK
  → 重要なメッセージのみ再送
  → ゲームの位置情報は再送しない
  → チャットメッセージは再送する

パターン2: 前方誤り訂正（FEC）
  → 冗長データを付加して、ロスを復元
  → 再送なしで信頼性を向上
  → 遅延を増やさない

パターン3: タイムスタンプ + 補間
  → 欠損データを前後の値から推定
  → ゲームの位置情報で使用
  → Dead Reckoning（推測航法）

  例: ゲームでの実装
  ┌───────────────────────────────────────┐
  │ UDP データグラム                       │
  │ ┌─────────────────────────────────┐   │
  │ │ seq: 42                         │   │
  │ │ ack: 38（受信確認）              │   │
  │ │ timestamp: 16842                │   │
  │ │ reliable: false                 │   │
  │ │ data: { x: 10.5, y: 3.2 }      │   │
  │ └─────────────────────────────────┘   │
  └───────────────────────────────────────┘
```

---

## 5. QUIC

```
QUIC = UDP上に構築された次世代トランスポートプロトコル
     = HTTP/3の基盤

  従来:  HTTP/2 → TLS 1.3 → TCP → IP
  QUIC:  HTTP/3 → QUIC(TLS内蔵) → UDP → IP

QUICの利点:
  ① 接続確立の高速化:
     TCP + TLS: 2〜3 RTT
     QUIC:      1 RTT（0-RTT再接続可能）

  ② Head-of-Line Blocking の解消:
     TCP: 1パケットロスで全ストリームが止まる
     QUIC: ストリームごとに独立（影響が局所的）

  ③ 接続の移行:
     TCP: IPアドレスが変わると切断（Wi-Fi ↔ 4G切替時）
     QUIC: Connection IDで管理（IPが変わっても維持）

  ④ 暗号化がデフォルト:
     → ヘッダーも暗号化（中間装置の干渉を防止）

  TCPとの比較:
  ┌──────────────┬──────────┬──────────┐
  │              │ TCP+TLS  │ QUIC     │
  ├──────────────┼──────────┼──────────┤
  │ 接続確立     │ 2-3 RTT  │ 1 RTT   │
  │ 再接続       │ 1-2 RTT  │ 0 RTT   │
  │ HoL Blocking │ あり      │ なし    │
  │ 接続移行     │ 不可      │ 可能    │
  │ 暗号化       │ オプション│ 必須    │
  └──────────────┴──────────┴──────────┘

主な採用:
  Google（YouTube, Gmail, Google Search）
  Cloudflare
  Meta（Facebook, Instagram）
  → 2024年時点で全Web通信の約8%がQUIC
```

---

## まとめ

| 概念 | ポイント |
|------|---------|
| UDP | コネクションレス、8バイトヘッダー |
| TCPとの違い | 信頼性・順序保証なし、高速 |
| ユースケース | DNS, ストリーミング, ゲーム, VPN |
| QUIC | UDP上の次世代プロトコル、HTTP/3の基盤 |

---

## 次に読むべきガイド
→ [[02-websocket.md]] — WebSocket

---

## 参考文献
1. RFC 768. "User Datagram Protocol." IETF, 1980.
2. RFC 9000. "QUIC: A UDP-Based Multiplexed and Secure Transport." IETF, 2021.
3. Langley, A. "The QUIC Transport Protocol." ACM SIGCOMM, 2017.
