# ロードバランシング

> ロードバランサーはトラフィックを複数のサーバーに分散し、可用性とスケーラビリティを実現する。L4/L7の違い、分散アルゴリズム、ヘルスチェックの仕組みを理解する。

## この章で学ぶこと

- [ ] L4とL7ロードバランシングの違いを理解する
- [ ] 主要な分散アルゴリズムを把握する
- [ ] AWSでのロードバランサー構成を学ぶ

---

## 1. ロードバランシングの基本

```
ロードバランサー = トラフィックの振り分け装置

  クライアント
       │
  ┌────▼────┐
  │ ロード   │
  │ バランサー│
  └─┬──┬──┬─┘
    │  │  │
  ┌─▼┐┌▼─┐┌─▼┐
  │S1││S2││S3│  ← バックエンドサーバー
  └──┘└──┘└──┘

目的:
  ① 負荷分散: 1台への集中を防ぐ
  ② 高可用性: サーバー障害時に別サーバーへ
  ③ スケーラビリティ: サーバー追加で処理能力向上
  ④ メンテナンス: ローリングデプロイ（無停止更新）
```

---

## 2. L4 vs L7 ロードバランシング

```
L4（トランスポート層）:
  → IP + ポート番号で振り分け
  → パケットの中身を見ない
  → 高速（低レイテンシ）
  → TCP/UDP レベル

L7（アプリケーション層）:
  → HTTPヘッダー、URL、Cookieで振り分け
  → リクエストの内容に基づく高度なルーティング
  → TLS終端可能
  → WebSocket対応

  比較:
  ┌──────────────┬────────────────┬────────────────┐
  │              │ L4             │ L7             │
  ├──────────────┼────────────────┼────────────────┤
  │ 判断基準     │ IP + ポート     │ URL, ヘッダー等│
  │ 速度         │ 高速            │ やや遅い       │
  │ TLS終端      │ 不可（パススルー）│ 可能          │
  │ コンテンツ   │ 不可            │ パスベース      │
  │ ルーティング │                 │ ルーティング可  │
  │ ヘルスチェック│ TCP接続のみ     │ HTTP応答確認   │
  │ WebSocket   │ パススルー       │ 認識して処理   │
  └──────────────┴────────────────┴────────────────┘

L7 パスベースルーティング:
  /api/*     → APIサーバー群
  /static/*  → 静的ファイルサーバー
  /ws/*      → WebSocketサーバー

L7 ホストベースルーティング:
  api.example.com    → APIサーバー群
  app.example.com    → フロントエンドサーバー
  admin.example.com  → 管理画面サーバー
```

---

## 3. 分散アルゴリズム

```
① ラウンドロビン（Round Robin）:
  → 順番に振り分け: S1 → S2 → S3 → S1 → ...
  → 最もシンプル
  → サーバーの性能差がある場合は不均等

② 加重ラウンドロビン（Weighted Round Robin）:
  → サーバーの性能に応じた重み付け
  → S1(w=3): 3回, S2(w=2): 2回, S3(w=1): 1回

③ 最小接続数（Least Connections）:
  → 接続数が最も少ないサーバーへ
  → 長時間接続がある場合に有効

④ IPハッシュ（IP Hash）:
  → クライアントIPのハッシュ値で決定
  → 同じクライアントは常に同じサーバーへ
  → セッション固定（Sticky Session）

⑤ ランダム:
  → ランダムに選択
  → 大量のサーバーで統計的に均等化

⑥ 最小レスポンスタイム:
  → 応答時間が最も短いサーバーへ
  → リアルタイムのパフォーマンス考慮

選択基準:
  ステートレスAPI:    ラウンドロビン or 最小接続数
  WebSocket:          IPハッシュ or Cookie ベース
  異機種環境:         加重ラウンドロビン
  高パフォーマンス要求: 最小レスポンスタイム
```

---

## 4. ヘルスチェック

```
ヘルスチェック = サーバーの生死確認

  種類:
  ① TCP ヘルスチェック:
     → ポートに接続できるか
     → 最も基本的

  ② HTTP ヘルスチェック:
     → GET /health → 200 OK を期待
     → アプリケーションレベルの確認

  ③ カスタムヘルスチェック:
     → DB接続、キャッシュ接続等も確認
     → 依存サービスの状態も含む

  ヘルスチェックエンドポイント例:
  GET /health
  {
    "status": "healthy",
    "checks": {
      "database": "connected",
      "cache": "connected",
      "disk": "ok"
    },
    "uptime": 86400
  }

  パラメータ:
  間隔（Interval）:     30秒ごとにチェック
  タイムアウト:         5秒以内に応答なければ失敗
  不健全しきい値:       3回連続失敗で除外
  健全しきい値:         2回連続成功で復帰
```

---

## 5. AWSのロードバランサー

```
AWSのロードバランサー:

  ┌─────────────────┬────────┬──────────────────────┐
  │ 種類            │ レイヤー│ 用途                  │
  ├─────────────────┼────────┼──────────────────────┤
  │ ALB             │ L7     │ HTTP/HTTPS、パスベース│
  │ (Application)   │        │ ルーティング、gRPC    │
  ├─────────────────┼────────┼──────────────────────┤
  │ NLB             │ L4     │ TCP/UDP、超低レイテンシ│
  │ (Network)       │        │ 静的IP、高スループット│
  ├─────────────────┼────────┼──────────────────────┤
  │ GWLB            │ L3     │ セキュリティアプライアンス│
  │ (Gateway)       │        │ ファイアウォール、IDS │
  └─────────────────┴────────┴──────────────────────┘

ALB構成例:
  インターネット
       │
  ┌────▼────┐
  │  ALB    │ ← TLS終端、パスルーティング
  └─┬──┬──┬─┘
    │  │  │
    │  │  └─→ /api/* → Target Group A (ECS Fargate)
    │  └────→ /ws/*  → Target Group B (EC2)
    └──────→ /*     → Target Group C (S3 + CloudFront)

Sticky Session:
  → ALBのターゲットグループで設定
  → Cookie ベース（AWSALB）
  → Duration-based（期間指定）
  → Application-based（アプリのCookie利用）

Connection Draining:
  → サーバー除外時に処理中のリクエストを待つ
  → デフォルト300秒
  → ローリングデプロイに必須
```

---

## まとめ

| 概念 | ポイント |
|------|---------|
| L4 | IP+ポートで高速分散 |
| L7 | URL/ヘッダーで高度なルーティング |
| アルゴリズム | ラウンドロビン、最小接続数、IPハッシュ |
| ヘルスチェック | TCP/HTTP、自動除外/復帰 |
| AWS | ALB(L7), NLB(L4), GWLB(L3) |

---

## 次に読むべきガイド
→ [[01-cdn.md]] — CDN

---

## 参考文献
1. AWS. "Elastic Load Balancing Documentation." 2024.
2. Nginx. "Load Balancing." nginx.org, 2024.
